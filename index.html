<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Schoolyard - All-in-One School Management System</title>
    <link id="favicon" rel="icon" href="data:;base64,iVBORw0KGgo=">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .sidebar { transition: transform 0.3s ease-in-out; }
        .main-content { transition: margin-left 0.3s ease-in-out; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #a3a3a3; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #737373; }
        .toast { transition: opacity 0.5s, transform 0.5s; }
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); }
            .sidebar.open { transform: translateX(0); }
            .main-content { margin-left: 0; }
        }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #0ea5e9; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        :root {
            --primary-100: 224 242 254;
            --primary-400: #38bdf8;
            --primary-500: #0ea5e9;
            --primary-600: #0284c7;
            --primary-700: #0369a1;
            --fc-border-color: #e2e8f0; 
            --fc-daygrid-event-dot-width: 8px;
            --fc-today-bg-color: rgba(14, 165, 233, 0.1); 
            --fc-button-bg-color: var(--primary-500);
            --fc-button-border-color: var(--primary-500);
            --fc-button-hover-bg-color: var(--primary-600);
            --fc-button-hover-border-color: var(--primary-600);
        }
        .bg-primary-500 { background-color: var(--primary-500); }
        .bg-primary-600 { background-color: var(--primary-600); }
        .hover\:bg-primary-600:hover { background-color: var(--primary-600); }
        .hover\:bg-primary-700:hover { background-color: var(--primary-700); }
        .text-primary-600 { color: var(--primary-600); }
        .text-primary-700 { color: var(--primary-700); }
        .border-primary-500 { border-color: var(--primary-500); }
        .ring-primary-500:focus { --tw-ring-color: var(--primary-500) !important; }
        .bg-primary-100 { background-color: rgb(var(--primary-100)); }
        .nav-link.active { background-color: var(--primary-600); color: white; }
        .fc .fc-toolbar-title { font-size: 1.5em; font-weight: bold; color: #1e293b; }
        .fc .fc-daygrid-day-number { font-weight: 500; }
        .gradebook-table th, .gradebook-table td { white-space: nowrap; text-align: center; }
        .settings-tab.active, .course-tab.active, .report-tab.active { 
            border-color: var(--primary-500); 
            color: var(--primary-500); 
            background-color: rgb(var(--primary-100));
        }
        .printable-report { border: 1px solid #ddd; padding: 24px; font-family: 'Times New Roman', serif; color: black; background-color: white; }
        .printable-report h1, .printable-report h2, .printable-report h3 { color: black; }
        .printable-schedule-table { border-collapse: collapse; width: 100%; font-size: 12px;}
        .printable-schedule-table th, .printable-schedule-table td { border: 1px solid #ccc; padding: 8px; text-align: center; vertical-align: top;}
        .printable-schedule-table th { background-color: #f2f2f2; }
        .page-break { page-break-after: always; }
    </style>
</head>
<body class="bg-slate-100 antialiased">

    <div id="router-outlet"></div>
    
    <div id="modal-template" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4" onclick="closeModal()">
        <div id="modal-content" class="modal-content bg-white rounded-lg shadow-xl p-6 md:p-8 w-full max-w-lg" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modal-title" class="text-2xl font-bold text-slate-800"></h3>
                <button onclick="closeModal()" class="text-slate-500 hover:text-slate-800 text-3xl leading-none">&times;</button>
            </div>
            <div id="modal-body" class="overflow-y-auto max-h-[80vh]"></div>
        </div>
    </div>
    <div id="toast-container" class="fixed bottom-5 right-5 z-50"></div>

    <script src="config.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut, createUserWithEmailAndPassword, signInWithEmailAndPassword, updateProfile } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, setDoc, onSnapshot, addDoc, updateDoc, deleteDoc, query, where, writeBatch, getDocs, serverTimestamp, collectionGroup, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // This would be in your config.js file
        // const firebaseConfig = { apiKey: "...", authDomain: "...", projectId: "...", ... };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const state = {
            user: null, school: null, allUsers: [], students: [], teachers: [], courses: [],
            dayTypes: [], timeBlocks: [], masterCalendar: [], schedules: [],
            assignments: [], grades: [], attendance: [], attendanceNotes: [], events: [], announcements: [],
            tuitionItems: [], launchpadLinks: [], gradingPeriods: [], reportCardTemplates: [], generatedReportCards: [],
            unsubscribeListeners: [], currentCalendar: null,
        };

        const palettes = {
            sky: { 100: "224 242 254", 400: "#38bdf8", 500: "#0ea5e9", 600: "#0284c7", 700: "#0369a1" },
            indigo: { 100: "224 231 255", 400: "#818cf8", 500: "#6366f1", 600: "#4f46e5", 700: "#4338ca" },
            emerald: { 100: "209 250 229", 400: "#34d399", 500: "#10b981", 600: "#059669", 700: "#047857" },
            rose: { 100: "255 228 230", 400: "#fb7185", 500: "#f43f5e", 600: "#e11d48", 700: "#be123c" }
        };
        function applyTheme(themeName = 'sky') {
            const palette = palettes[themeName] || palettes.sky;
            const root = document.documentElement;
            Object.keys(palette).forEach(key => root.style.setProperty(`--primary-${key}`, palette[key]));
            const todayRgb = hexToRgb(palette['500']);
            if (todayRgb) {
                 root.style.setProperty('--fc-today-bg-color', `rgba(${todayRgb.r}, ${todayRgb.g}, ${todayRgb.b}, 0.1)`);
            }
        }
        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? { r: parseInt(result[1], 16), g: parseInt(result[2], 16), b: parseInt(result[3], 16) } : null;
        }

        const allNavLinks = {
            myday: { href: 'myday', text: 'My Day', icon: `<svg class="h-6 w-6 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a2 2 0 002 2h10a2 2 0 002-2V10M9 20h6"/></svg>`},
            parentDashboard: { href: 'dashboard', text: 'Dashboard', icon: `<svg class="h-6 w-6 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" /></svg>`},
            launchpad: { href: 'launchpad', text: 'Launchpad', icon: `<svg class="h-6 w-6 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" /></svg>`},
            courses: { href: 'courses', text: 'Courses', icon: `<svg class="h-6 w-6 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M12 14l9-5-9-5-9 5 9 5z" /><path d="M12 14l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0112 20.055a11.952 11.952 0 01-6.824-2.998 12.078 12.078 0 01.665-6.479L12 14z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 14l9-5-9-5-9 5 9 5zm0 0v6" /></svg>`},
            attendance: { href: 'attendance', text: 'Attendance', icon: `<svg class="h-6 w-6 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" /></svg>`},
            gradebook: { href: 'gradebook', text: 'Gradebook', icon: `<svg class="h-6 w-6 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7v8a2 2 0 002 2h4M8 7a2 2 0 012-2h4a2 2 0 012 2v8a2 2 0 01-2 2h-4a2 2 0 01-2-2z"/></svg>`},
            reportCards: { href: 'report-cards', text: 'Report Cards', icon: `<svg class="h-6 w-6 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>`},
            tuition: { href: 'tuition', text: 'Tuition & Billing', icon: `<svg class="h-6 w-6 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" /></svg>`},
            calendar: { href: 'calendar', text: 'Calendar', icon: `<svg class="h-6 w-6 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>`},
            reports: { href: 'reports', text: 'Reports', icon: `<svg class="h-6 w-6 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V7a2 2 0 012-2h2l2-2h4l2 2h2a2 2 0 012 2v10a2 2 0 01-2 2z" /></svg>`},
            users: { href: 'users', text: 'Users', icon: `<svg class="h-6 w-6 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M15 21a6 6 0 00-9-5.197m0 0A5.995 5.995 0 0012 12a5.995 5.995 0 00-3-5.197m-2 5.197a4 4 0 110-5.292" /></svg>`},
            profile: { href: 'profile', text: 'Profile', icon: `<svg class="h-6 w-6 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>`},
            settings: { href: 'settings', text: 'Settings', icon: `<svg class="h-6 w-6 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.096 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>`}
        };
        const rolesConfig = {
            admin: ['myday', 'launchpad', 'users', 'courses', 'attendance', 'gradebook', 'reportCards', 'calendar', 'reports', 'tuition', 'profile', 'settings'],
            teacher: ['myday', 'launchpad', 'courses', 'attendance', 'gradebook', 'reportCards', 'calendar', 'profile'],
            student: ['myday', 'launchpad', 'courses', 'gradebook', 'reportCards', 'calendar', 'tuition', 'profile'],
            parent: ['parentDashboard', 'launchpad', 'gradebook', 'reportCards', 'calendar', 'tuition', 'reports', 'profile'],
        };
        
        const templates = {
            authView: `
                <div class="h-screen w-screen flex flex-col items-center justify-center bg-slate-100 p-4" style="background-image: url('https://images.unsplash.com/photo-1481627834876-b7833e8f5570?q=80&w=2128&auto=format&fit=crop'); background-size: cover; background-position: center;">
                    <div id="view-container" class="bg-white/80 backdrop-blur-sm p-8 rounded-2xl shadow-2xl text-center max-w-sm w-full">
                        <div class="loader-container h-32 flex items-center justify-center"><div class="loader"></div></div>
                    </div>
                </div>`,
            appView: `
                <div class="flex h-screen">
                    <aside id="sidebar" class="sidebar fixed top-0 left-0 h-full bg-slate-900 text-white w-64 p-6 z-20 md:translate-x-0 overflow-y-auto">
                        <div id="sidebar-header" class="flex items-center justify-center mb-10 h-10"></div>
                        <nav id="nav"></nav>
                    </aside>
                    <main id="main-content" class="main-content flex-1 md:ml-64 overflow-y-auto">
                        <div class="p-6 md:p-8">
                            <header class="flex justify-between items-center mb-8">
                                <button id="sidebar-toggle" class="md:hidden p-2 rounded-md bg-slate-200 text-slate-800">
                                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" /></svg>
                                </button>
                                <h2 id="page-title" class="text-3xl font-bold text-slate-800"></h2>
                                <div class="flex items-center">
                                    <div id="user-info" class="text-right hidden sm:block"></div>
                                    <button id="logout-button" title="Logout" class="ml-4 bg-red-500 text-white p-2 rounded-full hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                                        <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 3a1 1 0 00-1 1v12a1 1 0 102 0V4a1 1 0 00-1-1zm10.293 9.293a1 1 0 001.414 1.414l3-3a1 1 0 000-1.414l-3-3a1 1 0 10-1.414 1.414L14.586 9H7a1 1 0 100 2h7.586l-1.293 1.293z" clip-rule="evenodd" /></svg>
                                    </button>
                                </div>
                            </header>
                            <div id="content" class="bg-white rounded-xl shadow-md p-6 min-h-[calc(100vh-150px)]">
                                <div class="loader-container h-64 flex items-center justify-center"><div class="loader"></div></div>
                            </div>
                        </div>
                    </main>
                </div>`
        };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                document.getElementById('router-outlet').innerHTML = templates.authView;
                try {
                    await findUserSchoolAndLogin(user);
                } catch (error) {
                    console.error("Login process failed:", error);
                    showToast(`An error occurred during login: ${error.message}`, 'error');
                    await signOut(auth); 
                }
            } else {
                handleLogout();
                router(); 
            }
        });

        async function findUserSchoolAndLogin(user) {
            const userQueryByEmail = query(collectionGroup(db, 'users'), where('email', '==', user.email));
            const userSnapshotByEmail = await getDocs(userQueryByEmail);

            if (!userSnapshotByEmail.empty) {
                const userDoc = userSnapshotByEmail.docs[0];
                const schoolId = userDoc.ref.parent.parent.id;

                if (userDoc.data().isPlaceholder) {
                    try {
                        await runTransaction(db, async (transaction) => {
                            const placeholderRef = userDoc.ref;
                            const newUserRef = doc(db, 'schools', schoolId, 'users', user.uid);
                            const pDoc = await transaction.get(placeholderRef);
                            if (!pDoc.exists()) {
                                throw new Error("This invitation has already been used or is invalid.");
                            }
                            const userData = pDoc.data();
                            transaction.set(newUserRef, { ...userData, uid: user.uid, displayName: user.displayName || userData.displayName, isPlaceholder: false, createdAt: serverTimestamp() });
                            transaction.delete(placeholderRef);
                        });
                        showToast('Account activated successfully!', 'success');
                        await loginToSchool(user.uid, schoolId);
                    } catch (e) {
                        console.error("Activation transaction failed: ", e);
                        showToast(`Account activation failed: ${e.message}. Please contact your administrator.`, 'error');
                        await signOut(auth);
                    }
                } else {
                    if (userDoc.id !== user.uid) {
                        throw new Error("User account mismatch. An account with this email already exists.");
                    }
                    await loginToSchool(userDoc.id, schoolId);
                }
            } else {
                const [page] = getRoute();
                if (page !== 'create-school') {
                    showToast("No invitation found for this email address.", "error");
                    await signOut(auth);
                } else {
                    router();
                }
            }
        }
        
        async function loginToSchool(userId, schoolId) {
            const schoolDoc = await getDoc(doc(db, 'schools', schoolId));
            const userDoc = await getDoc(doc(db, 'schools', schoolId, 'users', userId));
            if (schoolDoc.exists() && userDoc.exists()) {
                state.school = { id: schoolId, ...schoolDoc.data() };
                state.user = { id: userId, ...userDoc.data() };
                
                if (state.school.logoUrl) {
                    document.getElementById('favicon').href = state.school.logoUrl;
                }

                applyTheme(state.school.theme);
                await setupRealtimeListeners();
            } else {
                showToast("Your school or user account could not be found.", "error");
                await signOut(auth);
            }
        }

        function handleLogout() {
            if (state.unsubscribeListeners.length > 0) state.unsubscribeListeners.forEach(unsub => unsub());
            Object.keys(state).forEach(key => { state[key] = Array.isArray(state[key]) ? [] : null; });
            window.location.hash = '#/login';
        }
        
        window.addEventListener('hashchange', router);
        window.addEventListener('load', () => {
             if (!window.location.hash) {
                window.location.hash = '#/login';
            }
            router();
        });

        function getRoute() {
            const hash = window.location.hash.replace('#/', '');
            const [part1, part2] = hash.split('?');
            const [page, ...rest] = part1.split('/');
            return [page || 'login', rest, new URLSearchParams(part2 || '')];
        }

        function router() {
            const outlet = document.getElementById('router-outlet');
            if (!outlet) return;

            const [page, idParts, params] = getRoute();

            if (auth.currentUser && state.school) {
                if (!document.getElementById('main-content')) {
                    outlet.innerHTML = templates.appView;
                }
                renderAppShell();
                const renderFunction = routes[page]?.render;
                if (renderFunction) {
                    renderFunction(idParts, params);
                } else {
                    const defaultRoute = state.user.role === 'parent' ? 'dashboard' : 'myday';
                    window.location.hash = `#/${defaultRoute}`;
                    routes[defaultRoute].render();
                }
            } else {
                outlet.innerHTML = templates.authView;
                const authRoutes = {
                    'login': renderLoginView,
                    'signup': renderSignupView,
                    'create-school': renderCreateSchoolView
                };
                (authRoutes[page] || renderLoginView)();
            }
        }
        
        function renderLoginView() {
            const container = document.getElementById('view-container');
            if (!container) return;
            container.innerHTML = `
                <h1 class="text-3xl font-bold text-slate-800 mb-2">Welcome to Schoolyard</h1>
                <p class="text-slate-600 mb-6">Sign in to your school's portal.</p>
                <form id="login-form" class="text-left space-y-4">
                    <div>
                        <label for="email" class="font-semibold text-slate-700">Email</label>
                        <input id="email" type="email" autocomplete="email" class="w-full p-2 border rounded-lg mt-1" required>
                    </div>
                    <div>
                        <label for="password" class="font-semibold text-slate-700">Password</label>
                        <input id="password" type="password" autocomplete="current-password" class="w-full p-2 border rounded-lg mt-1" required>
                    </div>
                    <button type="submit" class="w-full bg-primary-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-primary-600">Sign In</button>
                </form>
                <div class="relative my-6">
                  <div class="absolute inset-0 flex items-center" aria-hidden="true"><div class="w-full border-t border-gray-300"></div></div>
                  <div class="relative flex justify-center"><span class="bg-white/80 px-2 text-sm text-gray-500">Or</span></div>
                </div>
                <button id="google-login-button" class="w-full bg-slate-800 text-white font-semibold py-2 px-4 rounded-lg hover:bg-slate-900 transition-colors flex items-center justify-center"><svg class="w-5 h-5 mr-3" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="white"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/><path d="M1 1h22v22H1z" fill="none"/></svg>Sign in with Google</button>
                <p class="text-xs text-slate-500 mt-4">Don't have an account? <a href="#/signup" class="text-primary-600 hover:underline">Sign Up</a>.</p>`;

            document.getElementById('login-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = e.target.elements.email.value;
                const password = e.target.elements.password.value;
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (err) { showToast(`Login failed: ${err.message}`, 'error'); }
            });
            document.getElementById('google-login-button').addEventListener('click', () => {
                const provider = new GoogleAuthProvider();
                signInWithPopup(auth, provider).catch(err => showToast(`Login failed: ${err.message}`, 'error'));
            });
        }

        function renderSignupView() {
            const container = document.getElementById('view-container');
            if (!container) return;
            container.innerHTML = `<h1 class="text-3xl font-bold text-slate-800 mb-2">Create an Account</h1>
            <p class="text-slate-600 mb-6">Create your account to join your school.</p>
            <form id="signup-form" class="text-left space-y-4">
                <div>
                    <label class="font-semibold text-slate-700">Your Full Name</label>
                    <input name="displayName" type="text" placeholder="e.g., John Appleseed" class="w-full p-2 border rounded-lg mt-1" required>
                </div>
                <div>
                    <label class="font-semibold text-slate-700">Your Email</label>
                    <input name="email" type="email" autocomplete="email" class="w-full p-2 border rounded-lg mt-1" required>
                </div>
                <div>
                    <label class="font-semibold text-slate-700">Password</label>
                    <input name="password" type="password" autocomplete="new-password" class="w-full p-2 border rounded-lg mt-1" required>
                </div>
                <button type="submit" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700">Sign Up</button>
            </form>
             <p class="text-xs text-slate-500 mt-4">Already have an account? <a href="#/login" class="text-primary-600 hover:underline">Sign In</a>.</p>
             <p class="text-xs text-slate-500 mt-2">Administrator? <a href="#/create-school" class="text-primary-600 hover:underline">Create a new school</a>.</p>
            `;
            document.getElementById('signup-form').addEventListener('submit', handleSignupSubmit);
        }

        async function handleSignupSubmit(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            const submitBtn = e.target.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.innerHTML = "Signing Up...";

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, data.email, data.password);
                await updateProfile(userCredential.user, { displayName: data.displayName });
                showToast('Account created! Checking for invitation...', 'success');
            } catch(err) {
                showToast(`Signup failed: ${err.message}`, 'error');
                submitBtn.disabled = false;
                submitBtn.innerHTML = "Sign Up";
            }
        }

        function renderCreateSchoolView() {
            const container = document.getElementById('view-container');
            if (!container) return;
            container.innerHTML = `<h1 class="text-3xl font-bold text-slate-800 mb-2">Create a New School</h1><p class="text-slate-600 mb-6">Let's get your new school portal started.</p>
            <form id="school-signup-form" class="text-left space-y-4">
                <div>
                    <label class="font-semibold text-slate-700">Your Full Name</label>
                    <input name="displayName" type="text" placeholder="e.g., Jane Doe" class="w-full p-2 border rounded-lg mt-1" required>
                </div>
                <div>
                    <label class="font-semibold text-slate-700">Your Admin Email</label>
                    <input name="email" type="email" value="${auth.currentUser?.email || ''}" class="w-full p-2 border rounded-lg mt-1" required>
                </div>
                <div>
                    <label class="font-semibold text-slate-700">Admin Password</label>
                    <input name="password" type="password" class="w-full p-2 border rounded-lg mt-1" required>
                </div>
                <div>
                    <label class="font-semibold text-slate-700">School Name</label>
                    <input name="schoolName" type="text" placeholder="e.g., Villanova Preparatory School" class="w-full p-2 border rounded-lg mt-1" required>
                </div>
                <button type="submit" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 flex items-center justify-center">Create School & Account</button>
            </form>
            <p class="text-xs text-slate-500 mt-4">Already have an account? <a href="#/login" class="text-primary-600 hover:underline">Sign in instead</a>.</p>`;
            
            document.getElementById('school-signup-form').addEventListener('submit', handleCreateSchoolSubmit);
        }

        async function handleCreateSchoolSubmit(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            let user = auth.currentUser;
            const submitBtn = e.target.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.innerHTML = `<div class="loader !w-6 !h-6 !border-2 !border-t-white mr-2"></div> Creating...`;
            
            try {
                if (!user || user.email !== data.email) {
                    const userCredential = await createUserWithEmailAndPassword(auth, data.email, data.password);
                    user = userCredential.user;
                    await updateProfile(user, { displayName: data.displayName });
                }

                const schoolRef = await addDoc(collection(db, 'schools'), { 
                    name: data.schoolName, 
                    theme: 'sky', 
                    logoUrl: '', 
                    createdAt: serverTimestamp() 
                });

                await setDoc(doc(db, 'schools', schoolRef.id, 'users', user.uid), { 
                    uid: user.uid, 
                    displayName: data.displayName, 
                    email: data.email, 
                    role: 'admin', 
                    isPlaceholder: false, 
                    createdAt: serverTimestamp() 
                });
                
                showToast('School created successfully! You are now logged in.', 'success');
            } catch (error) {
                console.error("Error creating school:", error);
                showToast(`Could not create school: ${error.message}`, 'error');
                submitBtn.disabled = false; submitBtn.textContent = 'Create School & Account';
            }
        }
        
        function renderAppShell() {
            const header = document.getElementById('sidebar-header');
            if(header) {
                if (state.school.logoUrl) {
                    header.innerHTML = `<img src="${state.school.logoUrl}" alt="${state.school.name} Logo" class="max-h-12 w-auto">`;
                } else {
                    header.innerHTML = `<h1 class="text-xl font-bold text-white">${state.school.name}</h1>`;
                }
            }
            const userInfo = document.getElementById('user-info');
            if (userInfo) userInfo.innerHTML = `<p class="font-semibold text-slate-800">${state.user.displayName}</p><p class="text-xs text-slate-500 capitalize">${state.user.role}</p>`;
            
            const logoutBtn = document.getElementById('logout-button');
            if(logoutBtn) logoutBtn.onclick = () => signOut(auth);

            const sidebarToggle = document.getElementById('sidebar-toggle');
            if(sidebarToggle) sidebarToggle.onclick = () => document.getElementById('sidebar').classList.toggle('open');
            
            populateNav();
        }

        function populateNav() {
            const navEl = document.getElementById('nav');
            if (!navEl || !state.user || !state.user.role) { return; }
            const [page] = getRoute();
            const allowedLinks = rolesConfig[state.user.role] || [];
            navEl.innerHTML = allowedLinks.map(linkKey => {
                const link = allNavLinks[linkKey];
                if (!link) return '';
                const href = `#/${link.href}`;
                return `<a href="${href}" class="nav-link flex items-center p-3 my-1 rounded-lg text-slate-300 hover:bg-primary-500 hover:text-white transition-colors duration-200 ${page === link.href ? 'active' : ''}">${link.icon} ${link.text}</a>`;
            }).join('');
        }

        async function setupRealtimeListeners() {
            if (state.unsubscribeListeners.length > 0) {
                state.unsubscribeListeners.forEach(unsub => unsub());
                state.unsubscribeListeners = [];
            }
        
            const schoolUnsub = onSnapshot(doc(db, 'schools', state.school.id), (doc) => {
                if (state.user) {
                    const oldTheme = state.school?.theme;
                    state.school = { id: doc.id, ...doc.data() };
                    if (state.school.theme !== oldTheme) applyTheme(state.school.theme);
                    if (state.school.logoUrl) {
                        document.getElementById('favicon').href = state.school.logoUrl;
                    } else {
                        document.getElementById('favicon').href = 'data:;base64,iVBORw0KGgo=';
                    }
                    if (document.getElementById('main-content')) renderAppShell();
                }
            }, (err) => handleError('school', err));
            state.unsubscribeListeners.push(schoolUnsub);
        
            const handleSnapshot = (key, snapshot) => {
                if (!state.user) return;
                state[key] = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                if (key === 'users') {
                    state.allUsers = state.users;
                    state.students = state.users.filter(u => u.role === 'student');
                    state.teachers = state.users.filter(u => u.role === 'teacher');
                }
                router(); 
            };
        
            const handleError = (key, error) => {
                console.error(`Error listening to ${key}:`, error);
                showToast(`Permission error fetching '${key}'.`, 'error');
            };
        
            const role = state.user.role;
            let collectionsToListen = [];

            if (role === 'admin') {
                collectionsToListen = ['users', 'courses', 'dayTypes', 'timeBlocks', 'masterCalendar', 'schedules', 'assignments', 'grades', 'attendance', 'attendanceNotes', 'events', 'announcements', 'tuitionItems', 'launchpadLinks', 'gradingPeriods', 'reportCardTemplates', 'generatedReportCards'];
            } else if (role === 'teacher') {
                collectionsToListen = ['users', 'courses', 'dayTypes', 'timeBlocks', 'masterCalendar', 'schedules', 'assignments', 'grades', 'attendance', 'attendanceNotes', 'events', 'announcements', 'gradingPeriods', 'reportCardTemplates', 'launchpadLinks'];
            } else { // student or parent
                // *** FIX: Added 'gradingPeriods' to this list for parents/students to view report cards. ***
                collectionsToListen = ['users', 'courses', 'dayTypes', 'timeBlocks', 'masterCalendar', 'events', 'announcements', 'launchpadLinks', 'assignments', 'gradingPeriods'];
            }
            
            collectionsToListen.forEach(key => {
                const q = query(collection(db, 'schools', state.school.id, key));
                const unsub = onSnapshot(q, (snap) => handleSnapshot(key, snap), (err) => handleError(key, err));
                state.unsubscribeListeners.push(unsub);
            });

            if (role === 'student' || role === 'parent') {
                const studentIds = role === 'parent' ? (state.user.childrenIds || []) : [state.user.id];

                if (studentIds.length > 0) {
                     const collectionsToFilter = ['grades', 'tuitionItems', 'generatedReportCards', 'schedules'];
                     collectionsToFilter.forEach(key => {
                         const q = query(collection(db, 'schools', state.school.id, key), where('studentId', 'in', studentIds));
                         const unsub = onSnapshot(q, (snap) => handleSnapshot(key, snap), (err) => handleError(key, err));
                         state.unsubscribeListeners.push(unsub);
                     });
                }
            }
        }
        
        function canEdit(course) {
            if(!state.user) return false;
            const { role, id } = state.user;
            if (role === 'admin') return true;
            if (role === 'teacher' && course && course.teacherId === id) return true;
            return false;
        }

        function getEnrolledStudentIds(courseId) {
            const studentIds = new Set();
            state.schedules.forEach(schedule => {
                for (const timeBlockId in schedule.schedule) {
                    if (schedule.schedule[timeBlockId] === courseId) {
                        studentIds.add(schedule.studentId);
                    }
                }
            });
            return Array.from(studentIds);
        }

        function setPageTitle(title) { 
            const el = document.getElementById('page-title'); 
            if (el) el.textContent = title; 
        }
        
        const routes = {
            'myday': { render: renderMyDay }, 
            'dashboard': { render: renderParentDashboard },
            'launchpad': { render: renderLaunchpad },
            'courses': { render: renderCourses }, 
            'schedule': { render: renderScheduleEditor },
            'attendance': { render: renderAttendance },
            'gradebook': { render: renderGradebook }, 
            'tuition': { render: renderTuition },
            'calendar': { render: renderCalendar }, 
            'users': { render: renderUsers },
            'profile': { render: renderProfile }, 
            'settings': { render: renderSettings },
            'reports': { render: renderReports }, 
            'report-cards': { render: renderReportCards },
        };
        
        // --- All render functions below this point are included for completeness.
        // --- Key changes are in renderGradebook, openAssignmentModal, and openReportCardModal.
        
        function renderParentDashboard() {
             setPageTitle('Dashboard');
             const content = document.getElementById('content');
             if(!content) return;
             const children = state.students.filter(s => state.user.childrenIds?.includes(s.id));

             if (!children || children.length === 0) {
                 content.innerHTML = `<p class="text-slate-500">No students are currently assigned to your parent account. Please contact the school administrator.</p>`;
                 return;
             }

             const studentOptions = children.map(c => `<option value="${c.id}">${c.displayName}</option>`).join('');

             content.innerHTML = `
                 <div class="max-w-2xl mx-auto">
                     <h3 class="text-2xl font-bold text-slate-700 mb-6">Parent Dashboard</h3>
                     <div class="bg-slate-50 p-6 rounded-lg shadow-sm">
                         <h4 class="text-xl font-bold text-slate-700 mb-4">Submit Attendance Note</h4>
                         <form id="attendance-note-form">
                             <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                 <div>
                                     <label class="block font-semibold text-slate-700">Student</label>
                                     <select name="studentId" class="w-full p-2 border rounded-lg mt-1" required>${studentOptions}</select>
                                 </div>
                                 <div>
                                     <label class="block font-semibold text-slate-700">Date</label>
                                     <input type="date" name="date" value="${new Date().toISOString().split('T')[0]}" class="w-full p-2 border rounded-lg mt-1" required>
                                 </div>
                                 <div class="md:col-span-2">
                                     <label class="block font-semibold text-slate-700">Note Type</label>
                                     <select name="type" class="w-full p-2 border rounded-lg mt-1" required>
                                         <option value="sick">Sick Day</option>
                                         <option value="late">Arriving Late</option>
                                         <option value="early">Leaving Early</option>
                                     </select>
                                 </div>
                                 <div class="md:col-span-2">
                                     <label class="block font-semibold text-slate-700">Reason (optional)</label>
                                     <textarea name="reason" rows="3" placeholder="e.g., Doctor's appointment at 2 PM" class="w-full p-2 border rounded-lg mt-1"></textarea>
                                 </div>
                             </div>
                             <div class="text-right mt-4">
                                 <button type="submit" class="bg-primary-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-primary-600">Submit Note</button>
                             </div>
                         </form>
                     </div>
                 </div>
               `;
             document.getElementById('attendance-note-form').addEventListener('submit', handleAttendanceNoteSubmit);
        }

        function renderMyDay() {
            setPageTitle('My Day');
            const content = document.getElementById('content');
            if(!content) return;
            const today = new Date().toISOString().split('T')[0];
            const todaysCalendarEntry = state.masterCalendar.find(entry => entry.date === today);
            
            let html = `<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">`;
            
            html += `<div class="lg:col-span-1 bg-slate-50 p-4 rounded-lg"><h3 class="text-xl font-bold text-slate-700 mb-4">Today's Schedule</h3>`;
            if (todaysCalendarEntry) {
                const dayType = state.dayTypes.find(dt => dt.id === todaysCalendarEntry.dayTypeId);
                const timeBlocks = state.timeBlocks.filter(tb => tb.dayTypeId === dayType?.id).sort((a,b) => a.startTime.localeCompare(b.startTime));
                html += `<p class="font-semibold text-primary-600 mb-4">It's a "${dayType?.name || 'Unknown'}" day.</p>`;
                if (timeBlocks.length > 0 && (state.user.role === 'student' || state.user.role === 'parent')) {
                    html += `<ul class="space-y-2">`;
                    const mySchedule = state.schedules.find(s => s.studentId === state.user.id);
                    timeBlocks.forEach(tb => {
                        const courseId = mySchedule?.schedule[tb.id];
                        const course = courseId ? state.courses.find(c => c.id === courseId) : null;
                        html += `<li class="p-3 bg-white rounded-md shadow-sm"><p class="font-bold text-slate-600">${tb.startTime} - ${tb.endTime}</p><p class="font-semibold text-slate-800">${tb.name}</p><p class="text-slate-500">${course ? course.name : 'Free Period'}</p></li>`;
                    });
                    html += `</ul>`;
                } else if (timeBlocks.length === 0) {
                    html += `<p class="text-slate-500">No time blocks defined for this day type.</p>`;
                } else {
                     html += `<p class="text-slate-500">View your assigned courses on the Courses page.</p>`;
                }
            } else { 
                html += `<p class="text-slate-500">No school day scheduled for today.</p>`; 
            }
            html += `</div>`;

            const studentIds = state.user.role === 'parent' ? state.user.childrenIds || [] : (state.user.role === 'student' ? [state.user.id] : []);
            const myCourses = state.courses.filter(c => {
                 if (state.user.role === 'teacher') return c.teacherId === state.user.id;
                 if (state.user.role === 'admin') return true;
                 const enrolledIds = getEnrolledStudentIds(c.id);
                 return studentIds.some(sid => enrolledIds.includes(sid));
            });
            const myCourseIds = myCourses.map(c => c.id);

            html += `<div class="lg:col-span-2 space-y-6">`;
            html += `<div class="bg-slate-50 p-4 rounded-lg"><h3 class="text-xl font-bold text-slate-700 mb-4">Upcoming Assignments</h3>`;
            const upcomingAssignments = state.assignments.filter(a => myCourseIds.includes(a.courseId) && new Date(a.dueDate) >= new Date()).sort((a,b) => new Date(a.dueDate) - new Date(b.dueDate));
            if (upcomingAssignments.length > 0) {
                html += `<ul class="space-y-2">${upcomingAssignments.slice(0, 5).map(assign => { const course = state.courses.find(c => c.id === assign.courseId); return `<li class="p-3 bg-white rounded-md shadow-sm flex justify-between items-center"><div><p class="font-bold text-slate-800">${assign.title}</p><p class="text-sm text-slate-500">${course?.name || ''}</p></div><span class="font-semibold text-red-600">Due: ${assign.dueDate}</span></li>`; }).join('')}</ul>`;
            } else { html += `<p class="text-slate-500">No upcoming assignments. Great job!</p>`; }
            html += `</div>`;
            html += `<div class="bg-slate-50 p-4 rounded-lg"><h3 class="text-xl font-bold text-slate-700 mb-4">Recent Announcements</h3>`;
            const recentAnnouncements = state.announcements.filter(a => myCourseIds.includes(a.courseId) || a.courseId === 'school-wide').sort((a,b) => b.createdAt?.toDate() - a.createdAt?.toDate());
             if (recentAnnouncements.length > 0) {
                html += `<ul class="space-y-3">${recentAnnouncements.slice(0, 3).map(ann => { const course = state.courses.find(c => c.id === ann.courseId); const author = state.allUsers.find(u => u.id === ann.authorId); return `<li class="p-3 bg-white rounded-md shadow-sm"><div><p class="font-bold text-slate-800">${course?.name || 'School Announcement'}</p><p class="text-sm text-slate-500">By ${author?.displayName || 'Admin'} on ${ann.createdAt?.toDate().toLocaleDateString()}</p></div><p class="mt-2 text-slate-700">${ann.content}</p></li>`; }).join('')}</ul>`;
            } else { html += `<p class="text-slate-500">No recent announcements.</p>`; }
            html += `</div></div></div>`;
            content.innerHTML = html;
        }

        function renderLaunchpad() {
            setPageTitle('Launchpad');
            const content = document.getElementById('content');
            if(!content) return;
            const links = state.launchpadLinks.sort((a, b) => a.name.localeCompare(b.name));
            let html = ``;
            if(state.user.role === 'admin') {
                html += `<div class="flex justify-end mb-4"><a href="#/settings?tab=launchpad" class="bg-primary-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-primary-600">Manage Links</a></div>`;
            }
            if (links.length === 0) {
                html += `<p class="text-slate-500 text-center py-8">No Launchpad links have been configured by the administrator.</p>`;
            } else {
                html += `<div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-6">${links.map(app => `<a href="${app.url}" target="_blank" rel="noopener noreferrer" class="flex flex-col items-center p-4 bg-slate-50 rounded-lg hover:bg-primary-100 hover:shadow-md transition-all"><div class="w-20 h-20 rounded-lg mb-2 bg-slate-200 flex items-center justify-center text-3xl font-bold text-primary-600">${app.name.charAt(0)}</div><span class="font-semibold text-slate-700 text-center">${app.name}</span></a>`).join('')}</div>`;
            }
            content.innerHTML = html;
        }

        function renderCourses(idParts, params) {
            const [courseId] = idParts;
            if (courseId) return renderCourseDetail(courseId, params);
            setPageTitle('Courses');
            const content = document.getElementById('content');
            if (!content) return;
            let html = `<div class="flex justify-between items-center mb-6"><h3 class="text-2xl font-bold text-slate-700">My Courses</h3>`;
            if (state.user.role === 'admin') html += `<button onclick="openCourseModal()" class="bg-primary-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-primary-600">Add Course</button>`;
            html += `</div>`;

            const studentIds = state.user.role === 'parent' ? state.user.childrenIds || [] : [state.user.id];
            
            const myCourses = state.courses.filter(c => {
                 if (state.user.role === 'admin') return true;
                 if (state.user.role === 'teacher') return c.teacherId === state.user.id;
                 const enrolledIds = getEnrolledStudentIds(c.id);
                 return studentIds.some(sid => enrolledIds.includes(sid));
            });

            if (myCourses.length === 0) {
                html += `<p class="text-slate-500">You are not enrolled in or assigned to any courses.</p>`;
            } else {
                html += `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">${myCourses.map(course => {
                    const teacher = state.allUsers.find(u => u.id === course.teacherId);
                    const enrolledStudentIds = getEnrolledStudentIds(course.id);
                    let adminControls = '';
                    if (canEdit(course)) {
                        adminControls = `
                            <div class="mt-4 pt-4 border-t border-slate-200 flex justify-end space-x-2">
                                <button onclick="openCourseModal('${course.id}', event)" class="text-xs font-semibold text-yellow-600 hover:text-yellow-800">EDIT</button>
                                <button onclick="deleteCourse('${course.id}', event)" class="text-xs font-semibold text-red-600 hover:text-red-800">DELETE</button>
                            </div>`;
                    }

                    return `
                        <div class="bg-white p-6 rounded-lg shadow hover:shadow-lg transition-shadow border-l-4 border-primary-500 flex flex-col justify-between">
                            <a href="#/courses/${course.id}" class="flex-grow">
                                <h4 class="text-xl font-bold text-slate-800 truncate">${course.name}</h4>
                                <p class="text-slate-600">Teacher: ${teacher ? teacher.displayName : 'Not Assigned'}</p>
                                <p class="text-sm text-slate-500 mt-2">${enrolledStudentIds.length} students</p>
                            </a>
                            ${adminControls}
                        </div>`;
                }).join('')}</div>`;
            }
            content.innerHTML = html;
        }

        function renderCourseDetail(courseId, params) {
            const course = state.courses.find(c => c.id === courseId);
            const content = document.getElementById('content');
            if (!content) return;
            if (!course) { content.innerHTML = `<p>Course not found.</p><a href="#/courses">&larr; Back to courses</a>`; return; }
            
            const currentTab = params.get('tab') || 'stream';
            setPageTitle(course.name);
            const teacher = state.allUsers.find(u => u.id === course.teacherId);
            content.innerHTML = `<div class="mb-6"><a href="#/courses" class="text-primary-600 hover:underline">&larr; Back to all courses</a></div><div class="p-4 rounded-lg bg-primary-600 text-white shadow-lg mb-6"><h3 class="text-3xl font-bold">${course.name}</h3><p>${teacher?.displayName || 'N/A'}</p></div><div class="flex border-b mb-6 overflow-x-auto"><a href="#/courses/${courseId}?tab=stream" class="course-tab p-4 border-b-2 ${currentTab === 'stream' ? 'active' : ''}">Stream</a><a href="#/courses/${courseId}?tab=classwork" class="course-tab p-4 border-b-2 ${currentTab === 'classwork' ? 'active' : ''}">Classwork</a><a href="#/courses/${courseId}?tab=people" class="course-tab p-4 border-b-2 ${currentTab === 'people' ? 'active' : ''}">People</a>${canEdit(course) ? `<a href="#/courses/${courseId}?tab=attendance" class="course-tab p-4 border-b-2 ${currentTab === 'attendance' ? 'active' : ''}">Attendance</a>` : ''}</div><div id="course-content"></div>`;
            const tabRenderers = { 'stream': renderCourseStream, 'classwork': renderCourseClasswork, 'people': renderCoursePeople, 'attendance': renderCourseAttendance };
            (tabRenderers[currentTab] || tabRenderers.stream)(course);
        }
        
        function renderCourseStream(course) {
            const content = document.getElementById('course-content');
            if(!content) return;
            let formHtml = canEdit(course) ? `<div class="bg-white p-4 rounded-lg shadow mb-6"><form id="announcement-form"><textarea name="content" class="w-full p-2 border rounded-lg" placeholder="Announce something to your class" required></textarea><div class="text-right mt-2"><button type="submit" class="bg-primary-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-primary-600">Post</button></div></form></div>` : '';
            const announcements = state.announcements.filter(a => a.courseId === course.id).sort((a,b) => b.createdAt?.toDate() - a.createdAt?.toDate());
            let announcementsHtml = announcements.map(ann => { const author = state.allUsers.find(u => u.id === ann.authorId); return `<div class="bg-white p-4 rounded-lg shadow flex items-start space-x-4"><div class="bg-primary-500 text-white rounded-full h-10 w-10 flex-shrink-0 flex items-center justify-center font-bold">${author?.displayName?.charAt(0) || '?' }</div><div><p class="font-semibold">${author.displayName} <span class="text-sm text-slate-500 font-normal">${ann.createdAt?.toDate().toLocaleString() || ''}</span></p><p class="mt-1">${ann.content.replace(/\n/g, '<br>')}</p></div></div>` }).join('<hr class="my-6 border-slate-200">');
            if (announcements.length === 0) { announcementsHtml = `<p class="text-center text-slate-500 py-8">No announcements yet.</p>`; }
            content.innerHTML = `<div class="max-w-3xl mx-auto">${formHtml}${announcementsHtml}</div>`;
            if (canEdit(course)) { document.getElementById('announcement-form').addEventListener('submit', e => handleAnnouncementSubmit(e, course.id)); }
        }

        function renderCourseClasswork(course) {
            const content = document.getElementById('course-content');
            if(!content) return;
            let createButton = canEdit(course) ? `<button onclick="openAssignmentModal(null, '${course.id}')" class="bg-primary-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-primary-600">Create Assignment</button>` : '';
            const assignments = state.assignments.filter(a => a.courseId === course.id).sort((a,b) => new Date(b.dueDate) - new Date(a.dueDate));
            let assignmentsHtml = assignments.length > 0 ? `<ul class="space-y-3">${assignments.map(a => `<li class="p-4 bg-slate-50 rounded-md flex justify-between items-center"><div><p class="font-semibold text-lg text-slate-800">${a.title}</p><p class="text-sm text-slate-500">Due: ${a.dueDate} &bull; ${a.maxPoints || 0} pts</p></div>${canEdit(course) ? `<div class="flex space-x-2"><button onclick="openAssignmentModal('${a.id}', '${course.id}')" class="text-yellow-600 hover:text-yellow-800 font-semibold">Edit</button><button onclick="deleteAssignment('${a.id}')" class="text-red-600 hover:text-red-800 font-semibold">Delete</button></div>` : ''}</li>`).join('')}</ul>` : `<p class="text-center text-slate-500 py-8">No assignments have been created for this course yet.</p>`;
            content.innerHTML = `<div class="flex justify-end mb-4">${createButton}</div>${assignmentsHtml}`;
        }

        function renderCoursePeople(course) {
            const content = document.getElementById('course-content');
            if(!content) return;
            const teacher = state.allUsers.find(u => u.id === course.teacherId);
            const enrolledStudentIds = getEnrolledStudentIds(course.id);
            const enrolledStudents = state.students.filter(s => enrolledStudentIds.includes(s.id));

            let teacherHtml = `<div class="border-b-2 border-primary-500 pb-2 mb-4"><h3 class="text-2xl font-bold text-primary-600">Teacher</h3></div><div class="flex items-center space-x-4 p-2"><div class="bg-slate-200 text-slate-700 rounded-full h-10 w-10 flex items-center justify-center font-bold">${teacher?.displayName?.charAt(0) || '?'}</div><p class="text-lg">${teacher?.displayName || 'N/A'}</p></div>`;
            let studentsHtml = `<div class="border-b-2 border-primary-500 pb-2 mb-4 mt-8"><h3 class="text-2xl font-bold text-primary-600">Students</h3><p class="text-slate-500">${enrolledStudents.length} students</p></div><ul class="space-y-1">${enrolledStudents.map(s => `<li class="flex items-center space-x-4 p-2"><div class="bg-slate-200 text-slate-700 rounded-full h-10 w-10 flex-shrink-0 flex items-center justify-center font-bold">${s.displayName.charAt(0)}</div><p class="text-lg">${s.displayName}</p></li>`).join('')}</ul>`;
            content.innerHTML = `<div class="max-w-3xl mx-auto">${teacherHtml}${studentsHtml}</div>`;
        }

        function renderCourseAttendance(course) {
              const content = document.getElementById('course-content');
              if(!content) return;
              const today = new Date().toISOString().split('T')[0];
              const enrolledStudentIds = getEnrolledStudentIds(course.id);
              const students = state.students.filter(s => enrolledStudentIds.includes(s.id));
              const todaysAttendance = state.attendance.find(a => a.date === today && a.courseId === course.id);
              let html = `<div class="flex items-center justify-between mb-4"><h3 class="text-xl font-bold">Attendance for ${today}</h3><button id="save-attendance-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700">Save Attendance</button></div><form id="attendance-form"><table class="min-w-full bg-white"><thead class="bg-slate-100"><tr><th class="py-3 px-4 text-left font-semibold text-slate-600">Student Name</th><th class="py-3 px-4 text-center font-semibold text-slate-600">Present</th><th class="py-3 px-4 text-center font-semibold text-slate-600">Absent</th><th class="py-3 px-4 text-center font-semibold text-slate-600">Tardy</th></tr></thead><tbody>${students.map(student => { const status = todaysAttendance?.statuses?.[student.id] || 'present'; return `<tr class="border-b"><td class="py-3 px-4 font-medium">${student.displayName}</td><td class="py-3 px-4 text-center"><input type="radio" name="${student.id}" value="present" ${status === 'present' ? 'checked' : ''} class="w-5 h-5 text-primary-600 focus:ring-primary-500"></td><td class="py-3 px-4 text-center"><input type="radio" name="${student.id}" value="absent" ${status === 'absent' ? 'checked' : ''} class="w-5 h-5 text-primary-600 focus:ring-primary-500"></td><td class="py-3 px-4 text-center"><input type="radio" name="${student.id}" value="tardy" ${status === 'tardy' ? 'checked' : ''} class="w-5 h-5 text-primary-600 focus:ring-primary-500"></td></tr>` }).join('')}</tbody></table></form>`;
              content.innerHTML = html;
              document.getElementById('save-attendance-btn').addEventListener('click', () => handleAttendanceSubmit(course.id, today, todaysAttendance?.id));
        }
        
        function renderAttendance() {
            setPageTitle('Attendance');
            const content = document.getElementById('content');
            if(!content) return;
            if (state.user.role === 'admin' || state.user.role === 'teacher') {
                const notes = [...state.attendanceNotes].sort((a,b) => b.date.localeCompare(a.date));
                let notesHtml = `<div class="mb-8"><h3 class="text-xl font-bold text-slate-700 mb-4">Parent Submissions</h3>`;
                if(notes.length > 0) {
                      notesHtml += `<div class="space-y-3">${notes.map(note => {
                          const student = state.students.find(s => s.id === note.studentId);
                          return `<div class="p-4 rounded-lg bg-yellow-50 border border-yellow-200">
                              <div class="flex justify-between items-start">
                                  <div>
                                      <p class="font-bold text-slate-800">${student?.displayName || 'Unknown Student'}</p>
                                      <p class="text-sm"><span class="font-semibold capitalize">${note.type}</span> on <span class="font-semibold">${note.date}</span></p>
                                  </div>
                                  <p class="text-xs text-slate-500">${note.submittedAt?.toDate().toLocaleDateString()}</p>
                              </div>
                              ${note.reason ? `<p class="text-slate-700 mt-2 p-2 bg-yellow-100 rounded">${note.reason}</p>` : ''}
                          </div>`
                      }).join('')}</div>`;
                } else {
                    notesHtml += `<p class="text-slate-500">No new attendance notes from parents.</p>`;
                }
                notesHtml += `</div>`;

                const myCourses = state.courses.filter(c => c.teacherId === state.user.id || state.user.role === 'admin');
                if (myCourses.length === 0) {
                      content.innerHTML = notesHtml + `<p class="text-slate-500">You are not assigned to teach any courses.</p>`;
                      return;
                }
                let html = notesHtml + `<h3 class="text-xl font-bold text-slate-700 mb-4">Take Daily Attendance</h3><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">`;
                html += myCourses.map(course => {
                    const studentCount = getEnrolledStudentIds(course.id).length;
                    return `<a href="#/courses/${course.id}?tab=attendance" class="block p-4 bg-slate-50 hover:bg-primary-100 rounded-lg shadow-sm transition-colors"><p class="font-bold text-lg text-primary-700">${course.name}</p><p class="text-slate-500">${studentCount} students</p></a>`
                }).join('');
                html += `</div>`;
                content.innerHTML = html;
            } else {
                content.innerHTML = `<p class="text-slate-500">Attendance records are managed by teachers and administrators. Parents can submit attendance notes from the Dashboard.</p>`;
            }
        }
        
        function renderGradebook(idParts, params) {
            setPageTitle('Gradebook');
            const content = document.getElementById('content');
            if(!content) return;
            const courseId = params.get('courseId');
            
            if (state.user.role === 'student' || state.user.role === 'parent') {
                let html = `<h3 class="text-2xl font-bold text-slate-700 mb-6">My Grades</h3>`;
                const studentIds = state.user.role === 'parent' ? state.user.childrenIds || [] : [state.user.id];
                
                if (studentIds.length === 0 && state.user.role === 'parent') {
                    html += `<p class="text-slate-500">No students assigned to this account.</p>`;
                    content.innerHTML = html;
                    return;
                }

                studentIds.forEach(studentId => {
                    const student = state.students.find(s => s.id === studentId);
                    if (!student) return;

                    if (state.user.role === 'parent') {
                        html += `<h4 class="text-2xl font-semibold text-slate-600 mb-4 mt-6 border-t pt-4">${student.displayName}</h4>`;
                    }
                    
                    const enrolledCourses = state.courses.filter(c => getEnrolledStudentIds(c.id).includes(studentId));
                    
                    if(enrolledCourses.length === 0) {
                        html += `<p class="text-slate-500">Not enrolled in any courses.</p>`;
                    } else {
                       html += enrolledCourses.map(course => {
                            const assignments = state.assignments.filter(a => a.courseId === course.id);
                            if (assignments.length === 0) return `<div class="mb-8"><h5 class="text-xl font-bold text-primary-700 mb-2">${course.name}</h5><p class="text-slate-500 text-sm">No assignments yet.</p></div>`;
                            
                            let courseHtml = `<div class="mb-8"><h5 class="text-xl font-bold text-primary-700 mb-2">${course.name}</h5>`;
                            courseHtml += `<ul class="space-y-2">` + assignments.map(a => {
                                const grade = state.grades.find(g => g.assignmentId === a.id && g.studentId === studentId);
                                
                                let gradeDisplay = '';
                                if (grade?.score != null) {
                                    gradeDisplay = `<span class="font-semibold px-3">${grade.score} / ${a.maxPoints || '?'}</span>`;
                                } else {
                                    gradeDisplay = `<span class="font-semibold px-3 text-slate-400">Not Graded</span>`;
                                }

                                return `<li class="flex justify-between items-center p-3 bg-slate-50 rounded-md"><span>${a.title}</span>${gradeDisplay}</li>`;
                            }).join('') + `</ul>`;
                            return courseHtml + `</div>`;
                        }).join('');
                    }
                });
                content.innerHTML = html;
                return;
            }

            const myCourses = state.user.role === 'admin' ? state.courses : state.courses.filter(c => c.teacherId === state.user.id);
            if (myCourses.length === 0) {
                content.innerHTML = `<p class="text-slate-500">You are not assigned to teach any courses.</p>`;
                return;
            }
            let courseOptions = `<option value="">Select a course...</option>` + myCourses.map(c => `<option value="${c.id}" ${c.id === courseId ? 'selected' : ''}>${c.name}</option>`).join('');
            let html = `<div class="mb-4"><label for="gradebook-course-select" class="block font-semibold mb-2">Select a Course:</label><select id="gradebook-course-select" class="p-2 border rounded-lg w-full md:w-1/2">${courseOptions}</select></div>`;
            if (courseId) {
                const course = state.courses.find(c => c.id === courseId);
                const enrolledStudentIds = getEnrolledStudentIds(course.id);
                const students = state.students.filter(s => enrolledStudentIds.includes(s.id));
                const assignments = state.assignments.filter(a => a.courseId === courseId);
                const grades = state.grades.filter(g => g.courseId === courseId);
                html += `<div class="overflow-x-auto"><table class="min-w-full text-sm gradebook-table"><thead class="bg-slate-100"><tr><th class="p-2 border font-semibold text-left">Student Name</th>${assignments.map(a => `<th class="p-2 border font-semibold">${a.title}<br><span class="text-xs font-normal">(${a.maxPoints || 0} pts)</span></th>`).join('')}</tr></thead><tbody>${students.map(student => `<tr class="border-b"><td class="p-2 border font-medium text-left">${student.displayName}</td>${assignments.map(assignment => { const grade = grades.find(g => g.studentId === student.id && g.assignmentId === assignment.id); return `<td class="p-0 border"><input type="number" value="${grade?.score || ''}" onchange="updateGrade('${student.id}', '${assignment.id}', '${courseId}', this.value, '${grade?.id || ''}')" class="w-full h-full text-center p-2 outline-none focus:bg-primary-100" /></td>` }).join('')}</tr>`).join('')}</tbody></table></div>`;
            }
            content.innerHTML = html;
            const selectEl = document.getElementById('gradebook-course-select');
            if (selectEl) { selectEl.addEventListener('change', (e) => { window.location.hash = `#/gradebook?courseId=${e.target.value}`; }); }
        }

        function renderTuition() {
            setPageTitle('Tuition & Billing');
            const content = document.getElementById('content');
            if(!content) return;
            if (state.user.role === 'admin') {
                content.innerHTML = `This data is managed in <a href="#/settings?tab=tuition" class="text-primary-600 hover:underline">Settings &rarr; Tuition</a>. Parent statements can be generated in <a href="#/reports?tab=tuition" class="text-primary-600 hover:underline">Reports</a>.`;
                return;
            }
            const studentIds = state.user.role === 'parent' ? state.user.childrenIds || [] : [state.user.id];
            const myTuitionItems = state.tuitionItems.filter(item => studentIds.includes(item.studentId));
            const totalCharges = myTuitionItems.reduce((sum, item) => sum + (parseFloat(item.amount) || 0), 0);
            let html = `<div class="bg-slate-50 rounded-lg p-6 max-w-2xl mx-auto"><h3 class="text-xl font-bold text-slate-700 mb-4">Account Summary for ${state.user.displayName}</h3>`;
            if (myTuitionItems.length > 0) {
                html += `<table class="w-full mb-4"><thead><tr class="border-b"><th class="text-left font-semibold py-2">Item Description</th><th class="text-right font-semibold py-2">Amount</th></tr></thead><tbody>`;
                myTuitionItems.forEach(item => {
                    html += `<tr><td class="py-2">${item.description}</td><td class="text-right py-2">$${parseFloat(item.amount).toFixed(2)}</td></tr>`;
                });
                html += `</tbody></table>`;
            } else {
                html += `<p class="text-slate-500 mb-4">No tuition items have been posted to your account yet.</p>`;
            }
            html += `<div class="flex justify-between items-center border-t pt-4 mt-4"><p class="text-lg font-bold">Balance Due:</p><p class="text-lg font-bold text-red-600">$${totalCharges.toFixed(2)}</p></div><button onclick="openPaymentModal()" class="w-full mt-6 bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700">Make a Payment</button></div>`;
            content.innerHTML = html;
        }
        
        function renderCalendar() {
              setPageTitle('Calendar');
              const content = document.getElementById('content');
              if(!content) return;
              content.innerHTML = `<div id='calendar'></div>`;
              setTimeout(() => {
                  const calendarEl = document.getElementById('calendar');
                  if(!calendarEl || !state.courses) return;
                  const studentIds = state.user.role === 'parent' ? state.user.childrenIds || [] : [state.user.id];
                  const myCourseIds = state.courses.filter(c => {
                       if (state.user.role === 'admin' || state.user.role === 'teacher') return true;
                       const enrolledIds = getEnrolledStudentIds(c.id);
                       return studentIds.some(sid => enrolledIds.includes(sid));
                  }).map(c => c.id);

                  const assignmentEvents = state.assignments.filter(a => myCourseIds.includes(a.courseId)).map(a => ({ title: `Due: ${a.title}`, start: a.dueDate, allDay: true, backgroundColor: '#ef4444' }));
                  const schoolEvents = state.events.map(e => ({ title: e.title, start: e.date, allDay: true, backgroundColor: '#22c55e' }));
                  
                  if(state.currentCalendar) state.currentCalendar.destroy();
                  state.currentCalendar = new FullCalendar.Calendar(calendarEl, { initialView: 'dayGridMonth', headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek,listWeek' }, events: [...assignmentEvents, ...schoolEvents] });
                  state.currentCalendar.render();
              }, 0);
        }
        
        function renderUsers() {
            if(state.user.role !== 'admin') { document.getElementById('content').innerHTML = `<p>You do not have permission to view this page.</p>`; return; }
            setPageTitle('Users');
            const content = document.getElementById('content');
            if(!content) return;
            const allUsersSorted = [...state.allUsers].sort((a,b) => a.displayName.localeCompare(b.displayName));
            content.innerHTML = `<div class="flex justify-between items-center mb-6"><h3 class="text-2xl font-bold text-slate-700">User Management</h3><button onclick="openUserModal()" class="bg-primary-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-primary-600">Add User</button></div><div class="overflow-x-auto"><table class="min-w-full bg-white"><thead class="bg-slate-100"><tr><th class="py-3 px-4 text-left font-semibold text-slate-600">Name</th><th class="py-3 px-4 text-left font-semibold text-slate-600">Email</th><th class="py-3 px-4 text-left font-semibold text-slate-600">Role</th><th class="py-3 px-4 text-left font-semibold text-slate-600">Actions</th></tr></thead><tbody>${allUsersSorted.map(u => {
                let actions = `<button onclick="openUserModal('${u.id}')" class="text-yellow-600 hover:underline">Edit</button><button onclick="deleteUser('${u.id}')" class="ml-4 text-red-600 hover:underline">Delete</button>`;
                if (u.role === 'student') {
                    actions += `<a href="#/schedule/${u.id}" class="ml-4 text-green-600 hover:underline">Schedule</a>`;
                }
                return `<tr class="border-b"><td class="py-3 px-4">${u.displayName}</td><td class="py-3 px-4">${u.email}</td><td class="py-3 px-4 capitalize">${u.role}</td><td class="py-3 px-4">${actions}</td></tr>`
            }).join('')}</tbody></table></div>`;
        }

        function renderScheduleEditor(idParts) {
            const [studentId] = idParts;
            const student = state.students.find(s => s.id === studentId);
            const content = document.getElementById('content');
            if (!content || !student) {
                if(content) content.innerHTML = `<p>Student not found.</p>`;
                return;
            }

            setPageTitle(`Schedule for ${student.displayName}`);
            
            const scheduleDoc = state.schedules.find(s => s.studentId === studentId);
            const currentSchedule = scheduleDoc ? scheduleDoc.schedule : {};
            
            // Added a prominent Print button
            let html = `
                <div class="flex justify-between items-center mb-6">
                    <a href="#/users" class="text-primary-600 hover:underline">&larr; Back to all users</a>
                    <button type="button" onclick="openPrintableScheduleModal('${studentId}')" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 flex items-center">
                        <svg class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" /></svg>
                        Print Schedule
                    </button>
                </div>
                <form id="schedule-form">
                    <div class="space-y-8">
            `;

            state.dayTypes.forEach(dayType => {
                html += `<div><h3 class="text-2xl font-bold text-slate-700 mb-4">${dayType.name}</h3><div class="space-y-4">`;
                const timeBlocks = state.timeBlocks.filter(tb => tb.dayTypeId === dayType.id).sort((a,b) => a.startTime.localeCompare(b.startTime));

                if (timeBlocks.length === 0) {
                    html += `<p class="text-slate-500">No time blocks defined for this day type.</p>`;
                } else {
                    timeBlocks.forEach(block => {
                        const currentCourseId = currentSchedule[block.id] || '';
                        html += `
                            <div class="grid grid-cols-3 gap-4 items-center">
                                <label class="font-semibold text-slate-600 text-right">${block.name} (${block.startTime} - ${block.endTime})</label>
                                <div class="col-span-2">
                                    <select name="${block.id}" class="w-full p-2 border rounded-lg">
                                        <option value="">-- No Course --</option>
                                        ${state.courses.map(c => `<option value="${c.id}" ${currentCourseId === c.id ? 'selected' : ''}>${c.name}</option>`).join('')}
                                    </select>
                                </div>
                            </div>`;
                    });
                }
                html += `</div></div>`;
            });
            
            html += `
                    </div>
                    <div class="mt-8 text-right">
                        <button type="submit" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700">Save Schedule</button>
                    </div>
                </form>
            `;
            
            content.innerHTML = html;
            document.getElementById('schedule-form').addEventListener('submit', (e) => handleScheduleFormSubmit(e, studentId));
        }

        function renderProfile() {
            setPageTitle('Profile');
            const content = document.getElementById('content');
            if (!content) return;

            const isParent = state.user.role === 'parent';

            content.innerHTML = `<div class="bg-slate-50 p-6 rounded-lg max-w-md mx-auto">
                <form id="profile-form">
                    <div class="space-y-4">
                        <div>
                            <label class="block font-semibold text-slate-700">Full Name</label>
                            <input type="text" name="displayName" value="${state.user.displayName}" 
                                   class="w-full p-2 border rounded-lg mt-1 ${isParent ? 'bg-slate-100 cursor-not-allowed' : ''}" 
                                   ${isParent ? 'readonly' : ''}>
                            ${isParent ? `<p class="text-xs text-slate-500 mt-1">Parent names must be changed by a school administrator.</p>` : ''}
                        </div>
                        <div>
                            <label class="block font-semibold text-slate-700">Email</label>
                            <input type="email" value="${state.user.email}" class="w-full p-2 border rounded-lg mt-1 bg-slate-100" readonly>
                        </div>
                        <div>
                            <label class="block font-semibold text-slate-700">Role</label>
                            <p class="mt-2 inline-block bg-primary-100 text-primary-700 font-semibold px-3 py-1 rounded-full text-sm capitalize">${state.user.role}</p>
                        </div>
                        ${!isParent ? `<button type="submit" class="w-full bg-primary-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-primary-600">Save Changes</button>` : ''}
                    </div>
                </form>
            </div>`;

            if (!isParent) {
                document.getElementById('profile-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const newDisplayName = e.target.elements.displayName.value;
                    if (newDisplayName === state.user.displayName) return;
                    try {
                        await updateDoc(doc(db, 'schools', state.school.id, 'users', state.user.id), { displayName: newDisplayName });
                        if (auth.currentUser && auth.currentUser.displayName !== newDisplayName) {
                            await updateProfile(auth.currentUser, { displayName: newDisplayName });
                        }
                        showToast('Profile updated!', 'success');
                    } catch (err) {
                        showToast(`Error updating profile: ${err.message}`, 'error');
                    }
                });
            }
        }

        function renderSettings(idParts, params) {
            if (state.user.role !== 'admin') { document.getElementById('content').innerHTML = `<p>You do not have permission to view this page.</p>`; return; }
            setPageTitle('Settings');
            const content = document.getElementById('content');
            if(!content) return;
            const currentTab = params.get('tab') || 'general';
            const tabs = [
                { id: 'general', name: 'General' }, { id: 'academics', name: 'Academics' },
                { id: 'master_calendar', name: 'Master Calendar' }, { id: 'tuition', name: 'Tuition Items' },
                { id: 'launchpad', name: 'Launchpad' }
            ];
            content.innerHTML = `
                <div class="flex border-b mb-6 overflow-x-auto">
                    ${tabs.map(tab => `<a href="#/settings?tab=${tab.id}" class="settings-tab p-4 border-b-2 ${currentTab === tab.id ? 'active' : ''}">${tab.name}</a>`).join('')}
                </div>
                <div id="settings-content"></div>
            `;
            const tabRenderers = {
                'general': renderSettingsGeneral, 'academics': renderSettingsAcademics,
                'master_calendar': renderSettingsMasterCalendar, 'tuition': renderSettingsTuition,
                'launchpad': renderSettingsLaunchpad
            };
            (tabRenderers[currentTab] || tabRenderers.general)();
        }
        
        function renderReports(idParts, params) {
            setPageTitle('Reports');
            const content = document.getElementById('content');
            if(!content) return;

            if (state.user.role === 'admin') {
                const currentTab = params.get('tab') || 'enrollment';
                const tabs = [ 
                    { id: 'enrollment', name: 'Enrollment' }, 
                    { id: 'attendance', name: 'Attendance' },
                    { id: 'schedules', name: 'Student Schedules' },
                    { id: 'grades', name: 'Grade Distribution' },
                    { id: 'tuition', name: 'Tuition Statements'}
                ];
                
                content.innerHTML = `
                    <div class="flex justify-between items-center mb-6">
                        <div class="flex border-b overflow-x-auto">
                            ${tabs.map(tab => `<a href="#/reports?tab=${tab.id}" class="report-tab p-4 border-b-2 ${currentTab === tab.id ? 'active' : ''}">${tab.name}</a>`).join('')}
                        </div>
                    </div>
                    <div id="reports-content"></div>`;

                const tabRenderers = { 
                    'enrollment': renderEnrollmentReport, 
                    'attendance': renderAttendanceReport,
                    'schedules': renderScheduleReport,
                    'grades': renderGradeDistributionReport,
                    'tuition': renderAdminTuitionReport,
                };
                (tabRenderers[currentTab] || tabRenderers.enrollment)();
            } else if (state.user.role === 'parent') {
                renderParentTuitionReport();
            } else {
                 content.innerHTML = `<p>You do not have permission to view this page.</p>`;
            }
        }

        function renderParentTuitionReport() {
            setPageTitle('Reports');
            const content = document.getElementById('content');
            if (!content) return;

            content.innerHTML = `
                <div class="max-w-xl mx-auto bg-slate-50 p-6 rounded-lg shadow-sm">
                    <h3 class="text-2xl font-bold text-slate-700 mb-2">Tuition & Billing Statement</h3>
                    <p class="text-slate-500 mb-6">Generate a summary of all charges posted to your account for your records.</p>
                    <div class="text-center">
                        <button onclick="openParentStatementModal()" class="bg-primary-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-primary-600">
                            Generate Annual Statement
                        </button>
                    </div>
                </div>
            `;
        }

        function renderReportCards(idParts, params) {
            const content = document.getElementById('content');
            if(!content) return;
            if (state.user.role === 'student' || state.user.role === 'parent') {
                return renderStudentReportCards();
            }
            if (state.user.role !== 'admin') { content.innerHTML = `<p>You do not have permission to view this page.</p>`; return; }
            setPageTitle('Report Cards');
            
            const currentTab = params.get('tab') || 'generator';
            const tabs = [ { id: 'generator', name: 'Generator' }, { id: 'template', name: 'Template' } ];
            
            content.innerHTML = `
                <div class="flex border-b mb-6 overflow-x-auto">
                    ${tabs.map(tab => `<a href="#/report-cards?tab=${tab.id}" class="report-tab p-4 border-b-2 ${currentTab === tab.id ? 'active' : ''}">${tab.name}</a>`).join('')}
                </div>
                <div id="rc-content"></div>`;

            const tabRenderers = { 'generator': renderReportCardGenerator, 'template': renderReportCardTemplateEditor };
            (tabRenderers[currentTab] || tabRenderers.generator)();
        }

        function renderSettingsGeneral() {
            const content = document.getElementById('settings-content');
            if(!content) return;
            content.innerHTML = `
                <form id="general-settings-form" class="max-w-xl space-y-6">
                    <div>
                        <label for="school-name" class="block font-semibold text-slate-700">School Name</label>
                        <input type="text" id="school-name" name="name" value="${state.school.name}" class="mt-1 w-full p-2 border rounded-lg" required>
                    </div>
                    <div>
                        <label for="school-logo" class="block font-semibold text-slate-700">School Logo URL</label>
                        <input type="url" id="school-logo" name="logoUrl" value="${state.school.logoUrl || ''}" placeholder="https://..." class="mt-1 w-full p-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block font-semibold text-slate-700">Theme Color</label>
                        <div class="mt-2 flex flex-wrap gap-4">
                            ${Object.keys(palettes).map(theme => `
                                <label class="flex items-center space-x-2">
                                    <input type="radio" name="theme" value="${theme}" ${state.school.theme === theme ? 'checked' : ''} class="w-5 h-5 text-primary-600 focus:ring-primary-500 border-gray-300">
                                    <span class="capitalize">${theme}</span>
                                    <span class="h-6 w-6 rounded-full" style="background-color: ${palettes[theme][500]}"></span>
                                </label>
                            `).join('')}
                        </div>
                    </div>
                    <button type="submit" class="bg-primary-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-primary-600">Save Changes</button>
                </form>`;
            document.getElementById('general-settings-form').addEventListener('submit', handleGeneralSettingsSubmit);
        }

        function renderSettingsAcademics() {
            const content = document.getElementById('settings-content');
            if(!content) return;
            let dayTypesHtml = `<div class="mb-8">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-slate-700">Day Types & Time Blocks</h3>
                    <button onclick="openDayTypeModal()" class="bg-primary-500 text-white font-bold py-2 px-3 rounded-lg text-sm hover:bg-primary-600">Add Day Type</button>
                </div>
                ${state.dayTypes.map(dt => `
                    <div class="p-3 bg-slate-50 rounded-lg mb-2">
                        <div class="flex justify-between items-center">
                            <p class="font-semibold">${dt.name}</p>
                            <div>
                                <button onclick="openDayTypeModal('${dt.id}')" class="text-yellow-600 hover:underline text-sm">Edit</button>
                                <button onclick="duplicateDayType('${dt.id}')" class="text-blue-600 hover:underline text-sm ml-2">Duplicate</button>
                                <button onclick="deleteDayType('${dt.id}')" class="text-red-600 hover:underline text-sm ml-2">Delete</button>
                            </div>
                        </div>
                        <div class="mt-2 pl-4 border-l-2">
                            ${state.timeBlocks.filter(tb => tb.dayTypeId === dt.id).sort((a,b) => a.startTime.localeCompare(b.startTime)).map(tb => `
                                <div class="flex justify-between items-center p-1">
                                    <p>${tb.name} (${tb.startTime} - ${tb.endTime})</p>
                                    <div>
                                        <button onclick="openTimeBlockModal('${tb.id}', '${dt.id}')" class="text-yellow-600 hover:underline text-xs">Edit</button>
                                        <button onclick="deleteTimeBlock('${tb.id}')" class="text-red-600 hover:underline text-xs ml-2">Delete</button>
                                    </div>
                                </div>
                            `).join('') || '<p class="text-xs text-slate-500">No time blocks defined.</p>'}
                            <button onclick="openTimeBlockModal(null, '${dt.id}')" class="text-primary-600 hover:underline text-sm mt-2">+ Add Time Block</button>
                        </div>
                    </div>
                `).join('') || '<p class="text-slate-500">No day types created yet.</p>'}
            </div>`;

            let gradingPeriodsHtml = `<div>
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-slate-700">Grading Periods</h3>
                    <button onclick="openGradingPeriodModal()" class="bg-primary-500 text-white font-bold py-2 px-3 rounded-lg text-sm hover:bg-primary-600">Add Period</button>
                </div>
                ${state.gradingPeriods.sort((a,b) => new Date(a.startDate) - new Date(b.startDate)).map(p => `
                       <div class="flex justify-between items-center p-3 bg-slate-50 rounded-lg mb-2">
                           <p class="font-semibold">${p.name} <span class="font-normal text-slate-500">(${p.startDate} to ${p.endDate})</span></p>
                           <div>
                                <button onclick="openGradingPeriodModal('${p.id}')" class="text-yellow-600 hover:underline text-sm">Edit</button>
                                <button onclick="deleteGradingPeriod('${p.id}')" class="text-red-600 hover:underline text-sm ml-2">Delete</button>
                           </div>
                       </div>
                `).join('') || '<p class="text-slate-500">No grading periods created yet.</p>'}
            </div>`;
            content.innerHTML = dayTypesHtml + gradingPeriodsHtml;
        }

        function renderSettingsMasterCalendar() {
            const content = document.getElementById('settings-content');
            if(!content) return;
            content.innerHTML = `<p class="text-sm text-slate-600 mb-4">Click on any date to assign a day type (e.g., "A Day", "B Day") or to mark it as no school.</p><div id="settings-calendar"></div>`;
            setTimeout(() => {
                const calEl = document.getElementById('settings-calendar');
                if(!calEl) return;
                const cal = new FullCalendar.Calendar(calEl, {
                    initialView: 'dayGridMonth',
                    editable: true,
                    events: state.masterCalendar.map(entry => ({ id: entry.id, title: state.dayTypes.find(dt => dt.id === entry.dayTypeId)?.name || '?', start: entry.date })),
                    dateClick: (info) => {
                        const entry = state.masterCalendar.find(e => e.date === info.dateStr);
                        openMasterCalendarModal(info.dateStr, entry?.id);
                    },
                    eventClick: (info) => {
                        const entry = state.masterCalendar.find(e => e.id === info.event.id);
                        if (entry) openMasterCalendarModal(entry.date, entry.id);
                    }
                });
                cal.render();
            }, 0);
        }

        function renderSettingsTuition() {
            const content = document.getElementById('settings-content');
            if(!content) return;
            let html = `<div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-slate-700">Tuition Items</h3>
                    <button onclick="openTuitionItemModal()" class="bg-primary-500 text-white font-bold py-2 px-3 rounded-lg text-sm hover:bg-primary-600">Add Item</button>
                </div>`;
            if (state.tuitionItems.length > 0) {
                html += `<div class="overflow-x-auto"><table class="min-w-full bg-white"><thead class="bg-slate-100"><tr><th class="py-2 px-3 text-left">Student</th><th class="py-2 px-3 text-left">Description</th><th class="py-2 px-3 text-right">Amount</th><th class="py-2 px-3 text-right">Actions</th></tr></thead><tbody>`;
                state.tuitionItems.forEach(item => {
                    const student = state.students.find(s => s.id === item.studentId);
                    html += `<tr class="border-b"><td class="py-2 px-3">${student?.displayName || 'N/A'}</td><td class="py-2 px-3">${item.description}</td><td class="py-2 px-3 text-right">$${parseFloat(item.amount).toFixed(2)}</td><td class="py-2 px-3 text-right"><button onclick="openTuitionItemModal('${item.id}')" class="text-yellow-600 hover:underline text-sm">Edit</button><button onclick="deleteTuitionItem('${item.id}')" class="ml-2 text-red-600 hover:underline text-sm">Delete</button></td></tr>`;
                });
                html += `</tbody></table></div>`;
            } else {
                html += `<p class="text-slate-500">No tuition items have been added.</p>`;
            }
            content.innerHTML = html;
        }

        function renderSettingsLaunchpad() {
            const content = document.getElementById('settings-content');
            if(!content) return;
            let html = `<div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-slate-700">Launchpad Links</h3>
                    <button onclick="openLaunchpadLinkModal()" class="bg-primary-500 text-white font-bold py-2 px-3 rounded-lg text-sm hover:bg-primary-600">Add Link</button>
                </div>`;
            if (state.launchpadLinks.length > 0) {
                html += `<div class="space-y-2">`;
                state.launchpadLinks.forEach(link => {
                    html += `<div class="flex justify-between items-center p-3 bg-slate-50 rounded-lg"><div><p class="font-semibold">${link.name}</p><p class="text-sm text-slate-500">${link.url}</p></div><div><button onclick="openLaunchpadLinkModal('${link.id}')" class="text-yellow-600 hover:underline text-sm">Edit</button><button onclick="deleteLaunchpadLink('${link.id}')" class="ml-2 text-red-600 hover:underline text-sm">Delete</button></div></div>`;
                });
                html += `</div>`;
            } else {
                html += `<p class="text-slate-500">No launchpad links have been added.</p>`;
            }
            content.innerHTML = html;
        }
        
        // --- ALL "window" functions below are included for completeness. ---

        Object.assign(window, {
            closeModal: () => document.getElementById('modal-template').classList.add('hidden'),
            openModal: (title, body, size = 'lg') => { const m = document.getElementById('modal-template'); const mc = document.getElementById('modal-content'); if(!m || !mc) return; document.getElementById('modal-title').innerText = title; document.getElementById('modal-body').innerHTML = body; mc.className = mc.className.replace(/max-w-\S+/g, `max-w-${size}`); m.classList.remove('hidden'); m.classList.add('flex'); },
            showToast: (message, type = 'success') => { const c = document.getElementById('toast-container'); if(!c) return; const t = document.createElement('div'); t.className = `toast ${type === 'success' ? 'bg-green-500' : 'bg-red-500'} text-white font-bold py-2 px-4 rounded-lg shadow-lg mb-2 opacity-0 transform translate-y-2`; t.textContent = message; c.appendChild(t); setTimeout(() => t.classList.remove('opacity-0', 'translate-y-2'), 100); setTimeout(() => { t.classList.add('opacity-0'); t.addEventListener('transitionend', () => t.remove()); }, 4000); },
            
            openUserModal: (userId = null) => {
                const user = userId ? state.allUsers.find(u => u.id === userId) : null;
                const title = user ? `Edit User: ${user.displayName}` : 'Add New User';
                let parentFields = '';
                
                const studentOptions = state.students.map(s => `<option value="${s.id}" ${user?.childrenIds?.includes(s.id) ? 'selected' : ''}>${s.displayName}</option>`).join('');
                parentFields = `<div id="parent-fields" class="${user?.role === 'parent' ? '' : 'hidden'} mt-4">
                    <label class="block font-semibold mb-1">Assigned Children (Ctrl/Cmd to select multiple)</label>
                    <select name="childrenIds" multiple class="w-full p-2 border rounded-lg h-32">${studentOptions}</select>
                </div>`;

                const body = `<form id="user-form">
                    <input type="hidden" name="id" value="${user?.id||''}">
                    <label class="block font-semibold mb-1">Full Name</label>
                    <input type="text" name="displayName" value="${user?.displayName||''}" class="w-full p-2 border rounded-lg mb-4" required>
                    <label class="block font-semibold mb-1">Email</label>
                    <input type="email" name="email" value="${user?.email||''}" class="w-full p-2 border rounded-lg mb-4" ${user ? 'readonly' : 'required'}>
                    <label class="block font-semibold mb-1">Role</label>
                    <select id="role-select" name="role" class="w-full p-2 border rounded-lg mb-2" required>
                        <option value="student" ${user?.role==='student'?'selected':''}>Student</option>
                        <option value="teacher" ${user?.role==='teacher'?'selected':''}>Teacher</option>
                        <option value="parent" ${user?.role==='parent'?'selected':''}>Parent</option>
                        <option value="admin" ${user?.role==='admin'?'selected':''}>Admin</option>
                    </select>
                    ${parentFields}
                    <button type="submit" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 mt-6">Save</button>
                </form>`;
                openModal(title, body);
                document.getElementById('role-select').onchange = (e) => {
                    const parentFieldsEl = document.getElementById('parent-fields');
                    if (parentFieldsEl) parentFieldsEl.classList.toggle('hidden', e.target.value !== 'parent');
                };
                document.getElementById('user-form').addEventListener('submit', handleUserFormSubmit); 
            },
            handleUserFormSubmit: async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const data = {};
                formData.forEach((value, key) => {
                    if (key === 'childrenIds') {
                        if (!data[key]) data[key] = [];
                        data[key].push(value);
                    } else {
                        data[key] = value;
                    }
                });
                
                const userId = data.id;
                delete data.id; 
                if (data.role !== 'parent') {
                    data.childrenIds = [];
                }

                try {
                    if (userId) {
                        await updateDoc(doc(db, 'schools', state.school.id, 'users', userId), data);
                        showToast('User updated!', 'success');
                    } else {
                        await addDoc(collection(db, 'schools', state.school.id, 'users'), { ...data, isPlaceholder: true, uid: '' });
                        showToast('User invited! They must sign in to activate.', 'success');
                    }
                    closeModal();
                } catch (err) {
                    showToast(`Error: ${err.message}`, 'error');
                }
            },
            deleteUser: async (userId) => { if(userId === state.user.id) { showToast("You cannot delete yourself.", "error"); return; } if (confirm('Are you sure you want to delete this user? This cannot be undone.')) { try { await deleteDoc(doc(db, 'schools', state.school.id, 'users', userId)); showToast('User deleted.', 'success'); } catch (err) { showToast(`Error: ${err.message}`, 'error'); } } },
            
            handleAttendanceNoteSubmit: async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const data = Object.fromEntries(formData.entries());
                data.parentId = state.user.id;
                data.parentName = state.user.displayName;
                data.submittedAt = serverTimestamp();
                data.status = 'submitted';
                try {
                    await addDoc(collection(db, 'schools', state.school.id, 'attendanceNotes'), data);
                    showToast('Attendance note submitted successfully!', 'success');
                    e.target.reset();
                } catch (err) {
                    showToast(`Error submitting note: ${err.message}`, 'error');
                }
            },
            handleScheduleFormSubmit: async (e, studentId) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const scheduleData = Object.fromEntries(formData.entries());
                try {
                    await setDoc(doc(db, 'schools', state.school.id, 'schedules', studentId), {
                        studentId: studentId,
                        schedule: scheduleData
                    }, { merge: true });
                    showToast('Schedule saved successfully!', 'success');
                    window.location.hash = '#/users';
                } catch (err) {
                    console.error("Error saving schedule:", err);
                    showToast(`Error saving schedule: ${err.message}`, 'error');
                }
            },
            
            openCourseModal: (courseId = null, event) => { 
                if(event) event.stopPropagation(); 
                const course = courseId ? state.courses.find(c => c.id === courseId) : null; 
                let teacherOptions = state.teachers.map(t => `<option value="${t.id}" ${course?.teacherId === t.id ? 'selected' : ''}>${t.displayName}</option>`).join('');
                const title = course ? 'Edit Course' : 'Add New Course'; 
                const body = `<form id="course-form">
                    <input type="hidden" name="id" value="${course?.id || ''}">
                    <label class="block font-semibold mb-1">Name</label>
                    <input type="text" name="name" value="${course?.name || ''}" class="w-full p-2 border rounded-lg mb-4" required>
                    <label class="block font-semibold mb-1">Description</label>
                    <textarea name="description" class="w-full p-2 border rounded-lg mb-4">${course?.description || ''}</textarea>
                    <label class="block font-semibold mb-1">Teacher</label>
                    <select name="teacherId" class="w-full p-2 border rounded-lg mb-4"><option value="">-- Select --</option>${teacherOptions}</select>
                    <button type="submit" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg">Save</button>
                </form>`; 
                openModal(title, body, 'lg'); 
                document.getElementById('course-form').addEventListener('submit', handleCourseFormSubmit); 
            },
            handleCourseFormSubmit: async (e) => { 
                e.preventDefault(); 
                const formData = new FormData(e.target); 
                const courseId = formData.get('id'); 
                const data = { 
                    name: formData.get('name'), 
                    description: formData.get('description'), 
                    teacherId: formData.get('teacherId'),
                }; 
                try { 
                    if (courseId) { 
                        await updateDoc(doc(db, 'schools', state.school.id, 'courses', courseId), data); 
                        showToast('Course updated!', 'success'); 
                    } else { 
                        await addDoc(collection(db, 'schools', state.school.id, 'courses'), data); 
                        showToast('Course created!', 'success'); 
                    } 
                    closeModal(); 
                } catch (err) { 
                    showToast(`Error: ${err.message}`, 'error'); 
                } 
            },
            deleteCourse: async (courseId, event) => {
                event.stopPropagation();
                if (!confirm('Are you sure you want to delete this course? This will also delete all associated assignments, grades, attendance, and remove it from all student schedules. This action cannot be undone.')) return;

                showToast('Deleting course and all related data...', 'success');
                try {
                    const batch = writeBatch(db);
                    
                    const courseRef = doc(db, 'schools', state.school.id, 'courses', courseId);
                    batch.delete(courseRef);

                    const collectionsToDelete = ['assignments', 'grades', 'attendance', 'announcements'];
                    for (const coll of collectionsToDelete) {
                        const q = query(collection(db, 'schools', state.school.id, coll), where('courseId', '==', courseId));
                        const snapshot = await getDocs(q);
                        snapshot.forEach(doc => batch.delete(doc.ref));
                    }
                    
                    const schedulesSnapshot = await getDocs(collection(db, 'schools', state.school.id, 'schedules'));
                    schedulesSnapshot.forEach(scheduleDoc => {
                        const scheduleData = scheduleDoc.data();
                        const newSchedule = { ...scheduleData.schedule };
                        let scheduleWasModified = false;
                        for(const blockId in newSchedule) {
                            if (newSchedule[blockId] === courseId) {
                                delete newSchedule[blockId];
                                scheduleWasModified = true;
                            }
                        }
                        if (scheduleWasModified) {
                            batch.update(scheduleDoc.ref, { schedule: newSchedule });
                        }
                    });

                    await batch.commit();
                    showToast('Course deleted successfully.', 'success');
                } catch (err) {
                    console.error("Error deleting course:", err);
                    showToast(`Error deleting course: ${err.message}`, 'error');
                }
            },
            handleGeneralSettingsSubmit: async (e) => { e.preventDefault(); const formData = new FormData(e.target); const data = Object.fromEntries(formData.entries()); try { await updateDoc(doc(db, 'schools', state.school.id), data); showToast('Settings saved!', 'success'); } catch (err) { showToast(`Error: ${err.message}`, 'error'); } },
            handleAnnouncementSubmit: async (e, courseId) => { e.preventDefault(); const content = e.target.elements.content.value; if (!content.trim()) return; try { await addDoc(collection(db, 'schools', state.school.id, 'announcements'), { courseId, authorId: state.user.id, content, createdAt: serverTimestamp() }); e.target.reset(); } catch (err) { showToast(`Error: ${err.message}`, 'error') } },
            openAssignmentModal: (assignmentId, courseId) => { 
                const assignment = assignmentId ? state.assignments.find(a => a.id === assignmentId) : null; 
                const title = assignment ? 'Edit Assignment' : 'New Assignment'; 
                const body = `<form id="assignment-form">
                    <input type="hidden" name="id" value="${assignment?.id||''}">
                    <input type="hidden" name="courseId" value="${courseId}">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="md:col-span-2">
                            <label class="block font-semibold">Title</label>
                            <input type="text" name="title" value="${assignment?.title||''}" class="w-full p-2 border rounded-lg mt-1" required>
                        </div>
                        <div>
                            <label class="block font-semibold">Due Date</label>
                            <input type="date" name="dueDate" value="${assignment?.dueDate||''}" class="w-full p-2 border rounded-lg mt-1" required>
                        </div>
                        <div>
                            <label class="block font-semibold">Maximum Points</label>
                            <input type="number" name="maxPoints" value="${assignment?.maxPoints||'100'}" class="w-full p-2 border rounded-lg mt-1" required>
                        </div>
                    </div>
                    <button type="submit" class="w-full bg-green-600 text-white font-bold py-2 px-4 rounded-lg mt-6">Save Assignment</button>
                </form>`; 
                openModal(title, body); 
                document.getElementById('assignment-form').addEventListener('submit', handleAssignmentFormSubmit); 
            },
            handleAssignmentFormSubmit: async (e) => { 
                e.preventDefault(); 
                const formData = new FormData(e.target); 
                const data = Object.fromEntries(formData.entries()); 
                const assignmentId = data.id; 
                data.maxPoints = parseInt(data.maxPoints, 10);
                try { 
                    if (assignmentId) { 
                        await updateDoc(doc(db, 'schools', state.school.id, 'assignments', assignmentId), data); 
                        showToast('Assignment updated.', 'success'); 
                    } else { 
                        delete data.id; 
                        await addDoc(collection(db, 'schools', state.school.id, 'assignments'), data); 
                        showToast('Assignment created.', 'success'); 
                    } 
                    closeModal(); 
                } catch (err) { 
                    showToast(`Error: ${err.message}`, 'error') 
                } 
            },
            deleteAssignment: async (assignmentId) => { if (confirm('Delete this assignment?')) { await deleteDoc(doc(db, 'schools', state.school.id, 'assignments', assignmentId)); showToast('Assignment deleted.', 'success'); } },
            updateGrade: async (studentId, assignmentId, courseId, score, gradeId) => { const newGradeId = gradeId || `${studentId}_${assignmentId}`; const data = { studentId, assignmentId, courseId, score: score === '' ? null : parseFloat(score) }; try { await setDoc(doc(db, 'schools', state.school.id, 'grades', newGradeId), data, { merge: true }); showToast(`Grade saved.`, 'success'); } catch (err) { showToast(`Error: ${err.message}`, 'error'); } },
            handleAttendanceSubmit: async (courseId, date, attendanceId) => { const form = document.getElementById('attendance-form'); const formData = new FormData(form); const statuses = Object.fromEntries(formData.entries()); const data = { courseId, date, statuses }; try { const docRef = attendanceId ? doc(db, 'schools', state.school.id, 'attendance', attendanceId) : doc(collection(db, 'schools', state.school.id, 'attendance')); await setDoc(docRef, data, { merge: true }); showToast('Attendance saved!', 'success'); } catch (err) { showToast(`Error: ${err.message}`, 'error') } },
            openDayTypeModal: (dayTypeId = null) => { const dt = dayTypeId ? state.dayTypes.find(d => d.id === dayTypeId) : null; openModal(dt ? 'Edit Day Type' : 'Add Day Type', `<form id="day-type-form"><input type="hidden" name="id" value="${dt?.id||''}"><label class="block font-semibold">Name</label><input type="text" name="name" value="${dt?.name||''}" class="w-full p-2 border rounded-lg my-2" required><button type="submit" class="w-full bg-green-600 text-white font-bold py-2 px-4 rounded-lg">Save</button></form>`, 'md'); document.getElementById('day-type-form').addEventListener('submit', handleDayTypeSubmit); },
            handleDayTypeSubmit: async (e) => { e.preventDefault(); const id = e.target.elements.id.value; const name = e.target.elements.name.value; if (id) await updateDoc(doc(db, 'schools', state.school.id, 'dayTypes', id), { name }); else await addDoc(collection(db, 'schools', state.school.id, 'dayTypes'), { name }); closeModal(); },
            deleteDayType: async (id) => { if (confirm('Are you sure? This will delete the day type and all associated time blocks.')) { try { const batch = writeBatch(db); batch.delete(doc(db, 'schools', state.school.id, 'dayTypes', id)); const q = query(collection(db, 'schools', state.school.id, 'timeBlocks'), where('dayTypeId', '==', id)); const snapshot = await getDocs(q); snapshot.forEach(doc => batch.delete(doc.ref)); await batch.commit(); showToast('Day Type deleted.', 'success'); } catch(err) { showToast(`Error: ${err.message}`, 'error'); } } },
            duplicateDayType: async (dayTypeId) => {
                if (!confirm('Are you sure you want to duplicate this day type and all of its time blocks?')) return;
                const originalDayType = state.dayTypes.find(dt => dt.id === dayTypeId);
                const originalTimeBlocks = state.timeBlocks.filter(tb => tb.dayTypeId === dayTypeId);
                if (!originalDayType) {
                    showToast('Original day type not found.', 'error');
                    return;
                }
                try {
                    const batch = writeBatch(db);
                    const newDayTypeRef = doc(collection(db, 'schools', state.school.id, 'dayTypes'));
                    batch.set(newDayTypeRef, { name: `${originalDayType.name} (Copy)` });

                    originalTimeBlocks.forEach(block => {
                        const { id, dayTypeId, ...blockData } = block;
                        const newTimeBlockRef = doc(collection(db, 'schools', state.school.id, 'timeBlocks'));
                        batch.set(newTimeBlockRef, { ...blockData, dayTypeId: newDayTypeRef.id });
                    });
                    
                    await batch.commit();
                    showToast('Day Type duplicated successfully!', 'success');
                } catch(err) {
                    showToast(`Error duplicating day type: ${err.message}`, 'error');
                    console.error(err);
                }
            },
            openTimeBlockModal: (blockId = null, dayTypeId) => { const block = blockId ? state.timeBlocks.find(b => b.id === blockId) : null; const title = block ? 'Edit Time Block' : 'Add Time Block'; const body = `<form id="time-block-form"><input type="hidden" name="id" value="${block?.id||''}"><input type="hidden" name="dayTypeId" value="${dayTypeId}"><label class="block font-semibold">Block Name</label><input type="text" name="name" value="${block?.name||''}" class="w-full p-2 border rounded-lg my-2" required><label class="block font-semibold">Start Time</label><input type="time" name="startTime" value="${block?.startTime||''}" class="w-full p-2 border rounded-lg my-2" required><label class="block font-semibold">End Time</label><input type="time" name="endTime" value="${block?.endTime||''}" class="w-full p-2 border rounded-lg my-2" required><button type="submit" class="w-full bg-green-600 text-white font-bold py-2 px-4 rounded-lg">Save</button></form>`; openModal(title, body, 'md'); document.getElementById('time-block-form').addEventListener('submit', handleTimeBlockSubmit); },
            handleTimeBlockSubmit: async (e) => { e.preventDefault(); const formData = new FormData(e.target); const data = Object.fromEntries(formData.entries()); const id = data.id; delete data.id; if (id) await updateDoc(doc(db, 'schools', state.school.id, 'timeBlocks', id), data); else await addDoc(collection(db, 'schools', state.school.id, 'timeBlocks'), data); closeModal(); },
            deleteTimeBlock: async (id) => { if (confirm('Are you sure?')) await deleteDoc(doc(db, 'schools', state.school.id, 'timeBlocks', id)); },
            openMasterCalendarModal: (date, entryId = null) => { const entry = entryId ? state.masterCalendar.find(e => e.id === entryId) : null; const dayTypeOptions = state.dayTypes.map(dt => `<option value="${dt.id}" ${entry?.dayTypeId === dt.id ? 'selected' : ''}>${dt.name}</option>`).join(''); let deleteBtn = entryId ? `<button type="button" onclick="handleMasterCalendarDelete('${entryId}')" class="w-full bg-red-600 text-white font-bold py-2 px-4 rounded-lg mt-2">Remove Assignment</button>` : ''; openModal(`Assign Day for ${date}`, `<form id="mc-form"><input type="hidden" name="id" value="${entryId||''}"><input type="hidden" name="date" value="${date}"><label class="block font-semibold">Day Type</label><select name="dayTypeId" class="w-full p-2 border rounded-lg my-2"><option value="">-- No School --</option>${dayTypeOptions}</select><button type="submit" class="w-full bg-green-600 text-white font-bold py-2 px-4 rounded-lg">Save</button>${deleteBtn}</form>`, 'md'); document.getElementById('mc-form').addEventListener('submit', handleMasterCalendarSubmit); },
            handleMasterCalendarSubmit: async (e) => { e.preventDefault(); const formData = new FormData(e.target); const data = Object.fromEntries(formData.entries()); const id = data.id; if (!data.dayTypeId) { if(id) await handleMasterCalendarDelete(id); closeModal(); return; } delete data.id; const existing = state.masterCalendar.find(e => e.date === data.date); if (existing) await updateDoc(doc(db, 'schools', state.school.id, 'masterCalendar', existing.id), data); else await addDoc(collection(db, 'schools', state.school.id, 'masterCalendar'), data); closeModal(); },
            handleMasterCalendarDelete: async (id) => { if (confirm('Remove day type from this date?')) { await deleteDoc(doc(db, 'schools', state.school.id, 'masterCalendar', id)); closeModal(); } },
            openTuitionItemModal: (itemId = null) => { const item = itemId ? state.tuitionItems.find(i => i.id === itemId) : null; const studentOptions = state.students.map(s => `<option value="${s.id}" ${item?.studentId === s.id ? 'selected' : ''}>${s.displayName}</option>`).join(''); openModal(item ? 'Edit Tuition Item' : 'Add Tuition Item', `<form id="tuition-item-form"><input type="hidden" name="id" value="${item?.id||''}"><label class="block font-semibold">Student</label><select name="studentId" class="w-full p-2 border rounded-lg my-2" required><option value="">-- Select --</option>${studentOptions}</select><label class="block font-semibold">Description</label><input type="text" name="description" value="${item?.description||''}" class="w-full p-2 border rounded-lg my-2" required><label class="block font-semibold">Amount</label><input type="number" step="0.01" name="amount" value="${item?.amount||''}" class="w-full p-2 border rounded-lg my-2" required><button type="submit" class="w-full bg-green-600 text-white font-bold py-2 px-4 rounded-lg">Save</button></form>`); document.getElementById('tuition-item-form').addEventListener('submit', handleTuitionItemSubmit); },
            handleTuitionItemSubmit: async (e) => { e.preventDefault(); const formData = new FormData(e.target); const data = { studentId: formData.get('studentId'), description: formData.get('description'), amount: parseFloat(formData.get('amount')) }; const id = formData.get('id'); if (id) await updateDoc(doc(db, 'schools', state.school.id, 'tuitionItems', id), data); else await addDoc(collection(db, 'schools', state.school.id, 'tuitionItems'), data); closeModal(); },
            deleteTuitionItem: async (id) => { if (confirm('Delete this item?')) await deleteDoc(doc(db, 'schools', state.school.id, 'tuitionItems', id)); },
            openLaunchpadLinkModal: (linkId = null) => { const link = linkId ? state.launchpadLinks.find(l => l.id === linkId) : null; openModal(link ? 'Edit Link' : 'Add Link', `<form id="launchpad-link-form"><input type="hidden" name="id" value="${link?.id||''}"><label class="block font-semibold">Link Name</label><input type="text" name="name" value="${link?.name||''}" class="w-full p-2 border rounded-lg my-2" required><label class="block font-semibold">URL</label><input type="url" name="url" value="${link?.url||''}" class="w-full p-2 border rounded-lg my-2" required placeholder="https://..."><button type="submit" class="w-full bg-green-600 text-white font-bold py-2 px-4 rounded-lg">Save</button></form>`); document.getElementById('launchpad-link-form').addEventListener('submit', handleLaunchpadLinkSubmit); },
            handleLaunchpadLinkSubmit: async (e) => { e.preventDefault(); const formData = new FormData(e.target); const data = { name: formData.get('name'), url: formData.get('url') }; const id = formData.get('id'); if (id) await updateDoc(doc(db, 'schools', state.school.id, 'launchpadLinks', id), data); else await addDoc(collection(db, 'schools', state.school.id, 'launchpadLinks'), data); closeModal(); },
            deleteLaunchpadLink: async (id) => { if (confirm('Delete this link?')) await deleteDoc(doc(db, 'schools', state.school.id, 'launchpadLinks', id)); },
            openGradingPeriodModal: (periodId=null) => { const p = periodId ? state.gradingPeriods.find(gp => gp.id === periodId) : null; openModal(p ? 'Edit Grading Period' : 'Add Grading Period', `<form id="gp-form"><input type="hidden" name="id" value="${p?.id||''}"><label class="block font-semibold">Name</label><input type="text" name="name" value="${p?.name||''}" class="w-full p-2 border rounded-lg my-2" required><label class="block font-semibold">Start Date</label><input type="date" name="startDate" value="${p?.startDate||''}" class="w-full p-2 border rounded-lg my-2" required><label class="block font-semibold">End Date</label><input type="date" name="endDate" value="${p?.endDate||''}" class="w-full p-2 border rounded-lg my-2" required><button type="submit" class="w-full bg-green-600 text-white font-bold py-2 px-4 rounded-lg">Save</button></form>`); document.getElementById('gp-form').addEventListener('submit', handleGradingPeriodSubmit);},
            handleGradingPeriodSubmit: async (e) => { e.preventDefault(); try { const formData = new FormData(e.target); const data = Object.fromEntries(formData.entries()); const id = data.id; delete data.id; if(id) { await updateDoc(doc(db, 'schools', state.school.id, 'gradingPeriods', id), data); showToast('Grading period updated!', 'success'); } else { await addDoc(collection(db, 'schools', state.school.id, 'gradingPeriods'), data); showToast('Grading period added!', 'success'); } closeModal(); } catch (err) { showToast(`Error: ${err.message}`, 'error'); } },
            deleteGradingPeriod: async(id) => { if(confirm('Are you sure?')) await deleteDoc(doc(db, 'schools', state.school.id, 'gradingPeriods', id));},
            handleReportCardTemplateUpdate: async (e) => { e.preventDefault(); const formData = new FormData(e.target); const data = { includeGrades: formData.has('includeGrades'), includeAttendance: formData.has('includeAttendance'), includeComments: formData.has('includeComments') }; const id = formData.get('id'); try { const docRef = id ? doc(db, 'schools', state.school.id, 'reportCardTemplates', id) : doc(collection(db, 'schools', state.school.id, 'reportCardTemplates')); await setDoc(docRef, data); showToast('Template saved!', 'success'); } catch(err) { showToast(`Error: ${err.message}`, 'error'); } },
            deleteReportCard: async (rcId) => {
                if (confirm('Are you sure you want to delete this report card? This cannot be undone.')) {
                    try {
                        await deleteDoc(doc(db, 'schools', state.school.id, 'generatedReportCards', rcId));
                        showToast('Report card deleted.', 'success');
                    } catch (err) {
                        showToast(`Error deleting report card: ${err.message}`, 'error');
                    }
                }
            },
            generateReportCardsForPeriod: async(periodId) => { const btn = document.getElementById(`generate-rc-btn-${periodId}`); btn.disabled = true; btn.innerHTML = 'Generating...'; const period = state.gradingPeriods.find(p => p.id === periodId); const template = state.reportCardTemplates[0] || { includeGrades: true, includeAttendance: true }; try { const batch = writeBatch(db); state.students.forEach(student => { const reportCardId = `${student.id}_${periodId}`; const reportCardRef = doc(db, 'schools', state.school.id, 'generatedReportCards', reportCardId); batch.set(reportCardRef, { studentId: student.id, periodId: periodId, generatedAt: serverTimestamp(), studentName: student.displayName, periodName: period.name, template: template }); }); await batch.commit(); showToast(`Report cards generated for ${period.name}!`, 'success'); } catch (err) { showToast(`Error: ${err.message}`, 'error'); } finally { btn.disabled = false; btn.innerHTML = 'Generate'; } },
            openReportCardModal: (rcId) => {
                const rc = state.generatedReportCards.find(r => r.id === rcId);
                if (!rc) return showToast('Report card not found.', 'error');
                const period = state.gradingPeriods.find(p => p.id === rc.periodId);
                if(!period) return showToast('Grading period data not found. This may be a permission issue.', 'error');
                const studentCourses = state.courses.filter(c => getEnrolledStudentIds(c.id).includes(rc.studentId));
                
                let gradesHtml = '';
                if(rc.template.includeGrades) {
                    const gradesBody = studentCourses.map(course => {
                        const teacher = state.teachers.find(t => t.id === course.teacherId);
                        const assignmentsInPeriod = state.assignments.filter(a => a.courseId === course.id && a.dueDate >= period.startDate && a.dueDate <= period.endDate);
                        const gradesInPeriod = state.grades.filter(g => g.studentId === rc.studentId && assignmentsInPeriod.some(a => a.id === g.assignmentId));
                        
                        const totalPointsEarned = gradesInPeriod.reduce((sum, g) => sum + (parseFloat(g.score) || 0), 0);
                        const totalPointsPossible = assignmentsInPeriod.reduce((sum, a) => sum + (a.maxPoints || 0), 0);
                        
                        const finalGrade = totalPointsPossible > 0 ? `${((totalPointsEarned / totalPointsPossible) * 100).toFixed(2)}%` : 'N/A';
                        
                        return `<tr><td class="border-b p-2">${course.name}</td><td class="border-b p-2">${teacher?.displayName || ''}</td><td class="border-b p-2 font-bold">${finalGrade}</td></tr>`;
                    }).join('');
                    gradesHtml = `<h3 class="text-xl mb-2 mt-4">Course Grades</h3><table class="w-full text-left border-collapse"><thead><tr><th class="border-b p-2">Course</th><th class="border-b p-2">Teacher</th><th class="border-b p-2">Grade</th></tr></thead><tbody>${gradesBody}</tbody></table>`;
                }

                let attendanceHtml = '';
                if(rc.template.includeAttendance) {
                    const recordsInPeriod = state.attendance.filter(a => a.date >= period.startDate && a.date <= period.endDate);
                    let absentCount = 0;
                    let tardyCount = 0;
                    recordsInPeriod.forEach(rec => {
                        if (rec.statuses[rc.studentId] === 'absent') absentCount++;
                        if (rec.statuses[rc.studentId] === 'tardy') tardyCount++;
                    });
                    attendanceHtml = `<h3 class="text-xl mb-2 mt-4">Attendance</h3><p><strong>Absences:</strong> ${absentCount}</p><p><strong>Tardies:</strong> ${tardyCount}</p>`;
                }

                let title = `Report Card for ${rc.studentName}`;
                let body = `<div id="printable-area" class="printable-report">
                    <div class="text-center mb-6">
                        ${state.school.logoUrl ? `<img src="${state.school.logoUrl}" class="mx-auto h-16 mb-2">` : ''}
                        <h1 class="text-3xl">${state.school.name}</h1>
                        <h2 class="text-2xl">Official Report Card</h2>
                    </div>
                    <div class="flex justify-between mb-4">
                        <p><strong>Student:</strong> ${rc.studentName}</p>
                        <p><strong>Period:</strong> ${rc.periodName}</p>
                    </div>
                    ${gradesHtml}
                    ${attendanceHtml}
                </div>
                <button onclick="generatePdfFromHtml('printable-area', 'Report Card')" class="mt-4 w-full bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600">Download PDF</button>
                `;
                openModal(title, body, '5xl');
            },
            
            generatePdfFromHtml: async (elementId, pdfTitle) => {
                const { jsPDF } = window.jspdf;
                const reportContent = document.getElementById(elementId);
                if(!reportContent) return showToast('Could not find report content.', 'error');
                
                showToast('Generating PDF...', 'success');

                const canvas = await html2canvas(reportContent, { scale: 2 }); // Increase scale for better resolution
                const imgData = canvas.toDataURL('image/png');

                const pdf = new jsPDF('p', 'pt', 'letter');
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();
                const margin = 40;

                const contentWidth = pdfWidth - (margin * 2);
                
                const canvasWidth = canvas.width;
                const canvasHeight = canvas.height;
                const canvasAspectRatio = canvasWidth / canvasHeight;

                let finalWidth = contentWidth;
                let finalHeight = finalWidth / canvasAspectRatio;
                
                // Add Header
                pdf.setFontSize(18);
                pdf.text(state.school.name, margin, margin);
                pdf.setFontSize(14);
                pdf.text(pdfTitle, margin, margin + 24);
                pdf.setFontSize(10);
                pdf.text(`Generated on: ${new Date().toLocaleDateString()}`, pdfWidth - margin, margin + 10, { align: 'right' });

                pdf.addImage(imgData, 'PNG', margin, margin + 60, finalWidth, finalHeight);
                pdf.output('dataurlnewwindow');
            },
            
            openPaymentModal: () => {
                const studentIds = state.user.role === 'parent' ? state.user.childrenIds || [] : [state.user.id];
                const myTuitionItems = state.tuitionItems.filter(item => studentIds.includes(item.studentId));
                const totalCharges = myTuitionItems.reduce((sum, item) => sum + (parseFloat(item.amount) || 0), 0);
                
                if (totalCharges <= 0) {
                    showToast("No payment is due at this time.", "success");
                    return;
                }

                const title = 'Make a Payment';
                const body = `
                    <div class="text-center p-4">
                        <p class="text-lg text-slate-600 mb-2">Your total balance due is:</p>
                        <p class="text-4xl font-bold text-slate-800 mb-6">$${totalCharges.toFixed(2)}</p>
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-left">
                            <h4 class="font-bold text-blue-800 mb-2">Payment Instructions</h4>
                            <p class="text-slate-700">To pay your balance, please make a check payable to:</p>
                            <p class="font-semibold text-lg my-2">${state.school.name}</p>
                            <p class="text-slate-700">Please include your student's name in the memo line and mail it to the school office.</p>
                        </div>
                        <button onclick="closeModal()" class="mt-6 w-full bg-primary-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-primary-600">Close</button>
                    </div>
                `;
                openModal(title, body, 'lg');
            },
            openParentStatementModal: (parentId = null) => {
                const targetParent = parentId ? state.allUsers.find(u => u.id === parentId) : state.user;
                if (!targetParent) return showToast('Parent not found.', 'error');

                const studentIds = targetParent.childrenIds || [];
                const students = state.students.filter(s => studentIds.includes(s.id));
                const allItems = state.tuitionItems.filter(item => studentIds.includes(item.studentId));
                
                if (allItems.length === 0) {
                    showToast("No billing items found for this account.", "success");
                    return;
                }

                const total = allItems.reduce((sum, item) => sum + (parseFloat(item.amount) || 0), 0);

                const itemsHtml = allItems.sort((a,b) => (state.students.find(s=>s.id === a.studentId)?.displayName || '').localeCompare(state.students.find(s=>s.id === b.studentId)?.displayName || ''))
                    .map(item => {
                        const student = students.find(s => s.id === item.studentId);
                        return `
                            <tr class="border-b">
                                <td class="p-2">${student ? student.displayName : 'N/A'}</td>
                                <td class="p-2">${item.description}</td>
                                <td class="p-2 text-right">$${parseFloat(item.amount).toFixed(2)}</td>
                            </tr>
                        `;
                    }).join('');

                const title = `Annual Statement for ${targetParent.displayName}`;
                const body = `
                    <div id="printable-area" class="printable-report text-sm">
                        <div class="text-center mb-6">
                            ${state.school.logoUrl ? `<img src="${state.school.logoUrl}" class="mx-auto h-16 mb-2">` : ''}
                            <h1 class="text-3xl">${state.school.name}</h1>
                            <h2 class="text-2xl">Tuition & Billing Statement</h2>
                        </div>
                        <div class="mb-4">
                            <p><strong>Account Holder:</strong> ${targetParent.displayName}</p>
                            <p><strong>Date Generated:</strong> ${new Date().toLocaleDateString()}</p>
                        </div>
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr class="bg-slate-100">
                                    <th class="border-b p-2 font-bold">Student</th>
                                    <th class="border-b p-2 font-bold">Description</th>
                                    <th class="border-b p-2 font-bold text-right">Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${itemsHtml}
                            </tbody>
                            <tfoot>
                                <tr class="font-bold bg-slate-100">
                                    <td class="p-2" colspan="2">Total Charges</td>
                                    <td class="p-2 text-right">$${total.toFixed(2)}</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    <button onclick="generatePdfFromHtml('printable-area', 'Tuition Statement')" class="mt-4 w-full bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600">Download PDF</button>
                `;
                openModal(title, body, '5xl');
            },
            openPrintableScheduleModal: (studentId) => {
                const student = state.students.find(s => s.id === studentId);
                if (!student) return showToast('Student not found.', 'error');
                
                const title = `Schedule for ${student.displayName}`;
                const body = `
                    <div id="printable-schedule-content" class="printable-report">
                        </div>
                    <button onclick="generatePdfFromHtml('printable-schedule-content', 'Student Schedule for ${student.displayName}')" class="mt-4 w-full bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600">Download PDF</button>
                `;
                openModal(title, body, '6xl');
                renderPrintableSchedule(studentId);
            },
            renderPrintableSchedule: (studentId) => {
                const student = state.students.find(s => s.id === studentId);
                const scheduleData = state.schedules.find(s => s.studentId === studentId)?.schedule || {};
                const contentEl = document.getElementById('printable-schedule-content');
                if (!contentEl || !student) return;

                const allTimeSlots = state.timeBlocks.map(tb => `${tb.startTime} - ${tb.endTime}`);
                const uniqueTimeSlots = [...new Set(allTimeSlots)].sort();

                let html = `<div class="text-center mb-6">
                                <h1 class="text-3xl">${state.school.name}</h1>
                                <h2 class="text-2xl">Student Schedule: ${student.displayName}</h2>
                            </div>`;
                html += `<table class="printable-schedule-table"><thead><tr><th class="w-1/4">Time</th>`;
                state.dayTypes.forEach(dt => { html += `<th>${dt.name}</th>`; });
                html += `</tr></thead><tbody>`;

                uniqueTimeSlots.forEach(slot => {
                    const [start, end] = slot.split(' - ');
                    const representativeBlock = state.timeBlocks.find(tb => tb.startTime === start && tb.endTime === end);
                    html += `<tr><td><strong>${representativeBlock?.name || ''}</strong><br>${slot}</td>`;
                    
                    state.dayTypes.forEach(dt => {
                        const blockInDay = state.timeBlocks.find(tb => tb.dayTypeId === dt.id && tb.startTime === start && tb.endTime === end);
                        let cellContent = '';
                        if (blockInDay && scheduleData[blockInDay.id]) {
                            const course = state.courses.find(c => c.id === scheduleData[blockInDay.id]);
                            const teacher = state.teachers.find(t => t.id === course?.teacherId);
                            cellContent = `<strong>${course?.name || ''}</strong><br><span class="text-xs">${teacher?.displayName || ''}</span>`;
                        }
                        html += `<td>${cellContent}</td>`;
                    });
                    html += `</tr>`;
                });

                html += `</tbody></table>`;
                contentEl.innerHTML = html;
            }
        });
    </script>
</body>
</html>
